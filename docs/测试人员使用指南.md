# Smart Dev Mantis - 测试人员使用指南

> 文档版本: v1.0
> 更新日期: 2025-12-13
> 适用版本: Smart Dev Mantis v1.7+

---

## 一、概述

Smart Dev Mantis 是一款基于 AI 的接口自动化测试平台，能够根据 **Swagger 文档**、**PRD 需求文档** 和 **测试数据** 自动生成并执行测试用例。

### 1.1 三种测试模式

| 模式 | 输入文件 | 测试范围 | 适用场景 |
|------|----------|----------|----------|
| **接口测试** | Swagger (必填) | 参数边界、接口依赖、基础断言 | 新接口快速验证 |
| **业务测试** | Swagger + PRD | 接口测试 + 业务流程 + 规则验证 | 功能测试 |
| **完整测试** | Swagger + PRD + 测试数据 | 业务测试 + 数据驱动测试 | 回归测试 |

系统会根据上传的文件自动判断测试模式，**无需手动选择**。

---

## 二、Swagger 文档要求

### 2.1 支持的格式

| 格式 | 文件扩展名 | 说明 |
|------|-----------|------|
| OpenAPI 3.x | `.json`, `.yaml` | 推荐 |
| Swagger 2.0 | `.json`, `.yaml` | 支持 |

### 2.2 必要字段

以下字段用于生成高质量的测试用例：

```yaml
openapi: "3.0.0"
info:
  title: "API 名称"        # 用于报告标题
  version: "1.0.0"

paths:
  /api/users:
    post:
      summary: "创建用户"   # 用于用例描述
      operationId: "createUser"  # 用于函数命名
      parameters: [...]     # 用于参数边界测试
      requestBody:          # 用于请求体测试
        content:
          application/json:
            schema:
              type: object
              required: ["username", "email"]  # 必填字段
              properties:
                username:
                  type: string
                  minLength: 3      # 边界值
                  maxLength: 50
                  example: "testuser"  # 测试数据来源
```

### 2.3 建议添加的字段 (提升测试质量)

#### 1. Example 值
```yaml
properties:
  username:
    type: string
    example: "john_doe"  # AI 会优先使用这个值
  email:
    type: string
    example: "john@example.com"
```

#### 2. 依赖声明
在 `description` 中使用 `[依赖]` 标记接口依赖关系：

```yaml
/api/orders/{orderId}/pay:
  post:
    description: |
      支付订单
      [依赖] POST /api/orders → orderId
```

这会让 AI 自动：
- 先调用 POST /api/orders 创建订单
- 提取返回的 orderId
- 再调用支付接口

#### 3. 枚举值定义
```yaml
status:
  type: string
  enum: ["PENDING", "PAID", "SHIPPED", "COMPLETED"]  # 生成枚举测试
```

---

## 三、PRD 文档要求

### 3.1 支持的格式

| 格式 | 文件扩展名 | 说明 |
|------|-----------|------|
| Markdown | `.md`, `.markdown` | **推荐**，AI 理解效果最好 |
| Word | `.docx` | 支持，自动提取标题和表格 |
| 纯文本 | `.txt`, `.text` | 支持 |

### 3.2 编码要求

- 推荐使用 **UTF-8** 编码
- 系统会自动尝试：UTF-8 → GBK → GB2312 → Latin-1

### 3.3 PRD 文档结构 (推荐)

为了让 AI 能准确识别业务场景和规则，建议按以下结构组织 PRD：

```markdown
# 项目名称

## 一、业务背景
简要描述项目背景和目标...

## 二、业务流程

### 2.1 订单流程
用户下单流程如下：
1. 用户选择商品加入购物车
2. 提交订单，系统创建待支付订单
3. 用户完成支付，订单状态变为已支付
4. 商家发货，订单状态变为已发货
5. 用户确认收货，订单完成

### 2.2 退款流程
...

## 三、业务规则

### 3.1 价格计算规则
- 订单金额 = 商品单价 × 数量
- 满100减10，满200减25
- 运费规则：订单满99包邮，否则运费10元

### 3.2 库存规则
- 下单时锁定库存
- 支付成功后扣减库存
- 取消订单释放库存
- 库存不足时禁止下单

### 3.3 权限规则
- 只有管理员可以修改商品价格
- 用户只能查看自己的订单

## 四、接口说明
（可选，Swagger 中已有的接口信息）
```

### 3.4 关键词识别

AI 会自动识别以下关键词并提取相应内容：

#### 业务流程关键词
| 关键词模式 | AI 识别为 |
|-----------|-----------|
| `流程：...` | 业务流程 |
| `步骤：...` | 操作步骤 |
| `1. 用户...` | 用户操作 |
| `2. 系统...` | 系统行为 |

#### 业务规则关键词
| 关键词模式 | 规则类型 | 示例 |
|-----------|----------|------|
| `X = Y × Z` | 计算规则 | 订单金额 = 单价 × 数量 |
| `如果...则...` | 条件规则 | 如果库存不足，则返回错误 |
| `当...时...` | 条件规则 | 当金额满100时，减免10元 |
| `满XX减XX` | 满减规则 | 满200减25 |
| `不能超过...` | 约束规则 | 数量不能超过99 |
| `必须大于...` | 约束规则 | 金额必须大于0 |
| `只有...可以...` | 权限规则 | 只有管理员可以删除 |

### 3.5 PRD 示例

<details>
<summary>点击展开完整示例</summary>

```markdown
# 电商订单系统 PRD

## 一、业务背景
本系统为电商平台提供订单管理功能，包括下单、支付、发货、退款等完整流程。

## 二、业务流程

### 2.1 正常下单流程
1. 用户浏览商品，选择商品加入购物车
2. 用户提交订单，系统创建待支付订单
   - 系统检查库存，库存不足则提示错误
   - 系统锁定商品库存
   - 系统生成订单号，返回给用户
3. 用户完成支付
   - 调用支付接口
   - 支付成功后，订单状态变为 "已支付"
   - 扣减锁定的库存
4. 商家发货
   - 商家确认发货，填写物流单号
   - 订单状态变为 "已发货"
5. 用户确认收货
   - 用户确认收货或7天自动确认
   - 订单状态变为 "已完成"

### 2.2 退款流程
1. 用户发起退款申请（仅支持已支付未发货的订单）
2. 系统自动审核：
   - 订单金额 ≤ 100元，自动通过
   - 订单金额 > 100元，需人工审核
3. 退款通过后：
   - 原路退回支付金额
   - 恢复库存
   - 订单状态变为 "已退款"

## 三、业务规则

### 3.1 价格计算
- 商品金额 = 商品单价 × 购买数量
- 订单总额 = 商品金额 - 优惠金额 + 运费

### 3.2 优惠规则
- 满100减10
- 满200减25
- 满500减80
- 优惠不可叠加，取最大优惠

### 3.3 运费规则
- 订单商品金额 ≥ 99元：免运费
- 订单商品金额 < 99元：运费10元

### 3.4 库存规则
- 库存数量不能为负数
- 单次购买数量不能超过库存
- 单次购买数量最多99件

### 3.5 订单状态流转
| 当前状态 | 可流转到 | 触发条件 |
|---------|---------|---------|
| 待支付 | 已支付 | 支付成功 |
| 待支付 | 已取消 | 超时未支付/用户取消 |
| 已支付 | 已发货 | 商家发货 |
| 已支付 | 已退款 | 退款成功 |
| 已发货 | 已完成 | 用户确认/自动确认 |

### 3.6 权限规则
- 用户只能查看和操作自己的订单
- 商家只能操作自己店铺的订单
- 管理员可以查看所有订单
- 只有管理员可以修改订单金额
```

</details>

---

## 四、测试数据文件要求

### 4.1 支持的格式

| 格式 | 文件扩展名 | 说明 |
|------|-----------|------|
| Excel | `.xlsx` | **推荐**，支持多 Sheet |
| CSV | `.csv` | 支持，自动检测分隔符 |

### 4.2 数据文件结构

#### Excel 文件
- **第一行**：列标题（字段名）
- **后续行**：测试数据
- **多个 Sheet**：每个 Sheet 作为独立的数据集

#### CSV 文件
- 支持的分隔符：逗号`,`、分号`;`、制表符`\t`、竖线`|`
- 系统会自动检测分隔符

### 4.3 列名命名规范

**重要**：为了让系统自动将测试数据匹配到对应的 API 接口，列名应该与 Swagger 中定义的参数名一致。

```
Swagger 参数名    →    Excel 列名
username         →    username
email            →    email
phoneNumber      →    phoneNumber
```

### 4.4 特殊列 (可选)

以下特殊列用于指定测试期望结果：

| 列名 | 说明 | 示例值 |
|------|------|--------|
| `expected_code` | 期望的 HTTP 状态码 | `200`, `400`, `401` |
| `expected_status` | 期望的业务状态 | `success`, `fail` |
| `expected_message` | 期望的返回消息 | `创建成功` |
| `description` | 测试场景描述 | `正常注册` |

### 4.5 测试数据示例

#### 用户注册测试数据 (user_register.xlsx)

| description | username | email | phone | expected_code |
|-------------|----------|-------|-------|---------------|
| 正常注册 | testuser1 | test1@example.com | 13800001111 | 200 |
| 用户名为空 | | test2@example.com | 13800002222 | 400 |
| 邮箱格式错误 | testuser3 | invalid-email | 13800003333 | 400 |
| 手机号格式错误 | testuser4 | test4@example.com | 123 | 400 |
| 用户名过长(超50字符) | aaaa...aaa(60字符) | test5@example.com | 13800005555 | 400 |
| 重复用户名 | existuser | test6@example.com | 13800006666 | 409 |

#### 订单创建测试数据 (order_create.xlsx)

| description | productId | quantity | expected_code | expected_discount |
|-------------|-----------|----------|---------------|-------------------|
| 正常下单-小额 | P001 | 1 | 200 | 0 |
| 满100减10 | P002 | 2 | 200 | 10 |
| 满200减25 | P003 | 5 | 200 | 25 |
| 库存不足 | P004 | 9999 | 400 | |
| 商品不存在 | P999 | 1 | 404 | |

### 4.6 数据自动匹配

系统会基于 **列名与接口参数名的相似度** 自动匹配测试数据到 API 接口：

```
测试数据文件: user_register.xlsx
列名: [username, email, phone]
       ↓ 自动匹配
Swagger 接口: POST /api/users/register
参数: [username, email, phone]
匹配度: 100%  → 自动关联
```

---

## 五、文件准备清单

### 5.1 必须准备

| 文件 | 格式 | 说明 |
|------|------|------|
| Swagger 文档 | `.json` / `.yaml` | API 接口定义 |

### 5.2 建议准备 (提升测试质量)

| 文件 | 格式 | 用途 |
|------|------|------|
| PRD 文档 | `.md` / `.docx` | 业务流程和规则提取 |
| 测试数据 | `.xlsx` / `.csv` | 数据驱动测试 |

### 5.3 准备流程

```
Step 1: 准备 Swagger 文档
        ├── 确认包含所有接口
        ├── 补充 example 值
        └── 添加依赖声明 [依赖]

Step 2: 准备 PRD 文档 (可选)
        ├── 整理业务流程章节
        ├── 明确业务规则描述
        └── 使用标准关键词格式

Step 3: 准备测试数据 (可选)
        ├── 列名与 Swagger 参数对齐
        ├── 添加 expected_code 列
        └── 覆盖正常和异常场景

Step 4: 上传文件并执行
        └── 系统自动识别测试模式
```

---

## 六、常见问题

### Q1: PRD 文档太长怎么办？

系统会自动截取关键部分，优先保留包含"流程"、"规则"、"业务"等关键词的章节。建议将重要的业务规则放在文档靠前位置。

### Q2: 测试数据没有自动匹配到接口？

检查以下几点：
1. 列名是否与 Swagger 参数名一致
2. 匹配度是否超过 30%（至少有 30% 的列名相同）
3. 尝试重命名列名以匹配 Swagger 定义

### Q3: 生成的测试用例断言不符合预期？

1. 检查 PRD 中的业务规则描述是否清晰
2. 在 Swagger 中添加更详细的 `description`
3. 使用标准关键词格式描述规则（如"如果...则..."）

### Q4: 支持中文文件名吗？

支持。文件名、Sheet 名、列名均支持中文。

### Q5: 如何验证文件格式是否正确？

上传文件后，系统会在"智能分析预览"阶段显示：
- 识别到的业务场景数量
- 提取的业务规则数量
- 测试数据匹配结果
- 预计生成的测试用例数量

如果这些数值为 0，说明文件格式可能需要调整。

---

## 七、最佳实践

### 7.1 PRD 编写建议

1. **使用清晰的标题结构**：## 一级标题，### 二级标题
2. **流程使用编号列表**：1. 第一步 2. 第二步
3. **规则使用标准格式**：
   - 计算：`X = Y × Z`
   - 条件：`如果...则...`
   - 约束：`不能超过...` / `必须大于...`
4. **保持简洁**：避免过多的背景描述，聚焦业务逻辑

### 7.2 测试数据建议

1. **覆盖边界值**：最小值、最大值、临界值
2. **包含异常场景**：空值、超长、格式错误
3. **添加描述列**：方便理解每条数据的测试目的
4. **使用独立 Sheet**：按接口或功能模块分组

### 7.3 Swagger 优化建议

1. **补充 example**：提供真实可用的示例数据
2. **声明依赖关系**：使用 `[依赖]` 标记
3. **定义约束**：minLength、maxLength、enum 等
4. **完善描述**：operationId、summary、description

---

## 八、联系与反馈

如有问题，请联系开发团队或提交 Issue。
