# Smart Dev Mantis - 技术架构文档

> 文档版本: v1.7
> 更新日期: 2025-12-13
> 文档状态: 评审中
> 更新内容: 修复 Phase 2 PRD 数据注入断链问题，完善压力测试智能筛选功能

---

## 一、系统定位

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   传统模式:  人工编写测试脚本  →  人工执行  →  人工分析  →  人工修复        │
│                  ⬇                                                          │
│   Agent模式: 人工提供意图     →  AI生成    →  AI执行    →  AI自愈          │
│              (Swagger+需求)      (Pytest)     (运行)       (修复)           │
│                                                                             │
│   核心转变:  从 "人写代码" 转向 "人审代码"                                  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、整体架构（四层架构）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Layer 1: 表现层                                    │
│                        Presentation Layer                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                          Web UI / CLI                                  │  │
│  │   ┌──────────────┐  ┌──────────────┐  ┌────────────────────────────┐  │  │
│  │   │  输入面板     │  │  执行监控    │  │  结果展示 & 报告下载       │  │  │
│  │   │  - Swagger   │  │  - 实时日志  │  │  - 测试报告               │  │  │
│  │   │  - 业务规则  │  │  - 状态徽章  │  │  - Bug清单                │  │  │
│  │   │  - 环境配置  │  │  - 进度条    │  │  - 代码diff               │  │  │
│  │   │  - 业务数据  │  │              │  │                           │  │  │
│  │   └──────────────┘  └──────────────┘  └────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────┤
│                           Layer 2: 编排层                                    │
│                       Orchestration Layer                                    │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                     Python Driver (指挥官)                             │  │
│  │                                                                        │  │
│  │   ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐     │  │
│  │   │InputParser │  │PromptBuilder│ │ CLIAdapter │  │ResultJudge │     │  │
│  │   │ 输入解析   │  │ Prompt组装 │  │ CLI调用    │  │ 结果仲裁   │     │  │
│  │   └─────┬──────┘  └─────┬──────┘  └─────┬──────┘  └─────┬──────┘     │  │
│  │         │               │               │               │             │  │
│  │         └───────────────┴───────┬───────┴───────────────┘             │  │
│  │                                 │                                      │  │
│  │                    ┌────────────┴────────────┐                        │  │
│  │                    │    WorkflowEngine       │                        │  │
│  │                    │    工作流引擎            │                        │  │
│  │                    │    (状态机 + 自愈循环)   │                        │  │
│  │                    └─────────────────────────┘                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────┤
│                           Layer 3: 执行层                                    │
│                        Execution Layer                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                   Claude Code CLI (特种兵)                             │  │
│  │                                                                        │  │
│  │   通信方式: subprocess + 非交互模式 (-p --output-format json)          │  │
│  │                                                                        │  │
│  │   ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐     │  │
│  │   │ 代码生成   │  │ 文件读写   │  │ Bash执行   │  │ 错误分析   │     │  │
│  │   │ (Pytest)   │  │ (Read/Edit)│  │ (pytest)   │  │ (Traceback)│     │  │
│  │   └────────────┘  └────────────┘  └────────────┘  └────────────┘     │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
├─────────────────────────────────────────────────────────────────────────────┤
│                           Layer 4: 产出层                                    │
│                         Artifact Layer                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │   ┌───────────────┐ ┌───────────────┐ ┌───────────────┐ ┌──────────┐ │  │
│  │   │ Test Cases    │ │ Test Assets   │ │ Exec Report   │ │ Bug洞察  │ │  │
│  │   │ 测试用例文档   │ │ 测试资产       │ │ 执行报告       │ │          │ │  │
│  │   │               │ │               │ │               │ │          │ │  │
│  │   │ • testcases.md│ │ • test_*.py   │ │ • report.html │ │• bug.json│ │  │
│  │   │ (用例ID标记)  │ │ • conftest.py │ │ • results.xml │ │• 根因分析│ │  │
│  │   └───────────────┘ └───────────────┘ └───────────────┘ └──────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 三、核心组件详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          编排层核心组件                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  1. InputParser (输入解析器)                                         │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  职责: 解析和验证用户输入                                            │   │
│  │  输入: Swagger文件、需求文档、环境配置、业务数据(可选)                │   │
│  │  输出: 结构化的 TaskContext 对象                                     │   │
│  │                                                                      │   │
│  │  TaskContext {                                                       │   │
│  │    swagger: ParsedSwagger      // 解析后的API定义                    │   │
│  │    requirements: str           // 业务规则原文                       │   │
│  │    config: EnvConfig           // 环境配置                           │   │
│  │    data_assets: Optional[str]  // 业务数据原文 (可选)                │   │
│  │  }                                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  2. PromptBuilder (Prompt构建器)                                     │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  职责: 根据任务阶段构建精确的 Prompt                                  │   │
│  │                                                                      │   │
│  │  Prompt类型:                                                         │   │
│  │  ┌──────────────────┬───────────────────────────────────────────┐   │   │
│  │  │ PLAN_PROMPT      │ "分析Swagger，规划测试场景..."              │   │   │
│  │  │ GENERATE_PROMPT  │ "根据规划生成Pytest代码..."                 │   │   │
│  │  │ HEAL_SYNTAX      │ "分析报错日志，修复代码..."                 │   │   │
│  │  │ HEAL_LOGIC       │ "对比需求和结果，判断是否为Bug..."          │   │   │
│  │  └──────────────────┴───────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  3. CLIAdapter (CLI适配器) ✅ 已实现                                  │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  职责: 封装 Claude Code CLI 的调用                                   │   │
│  │                                                                      │   │
│  │  调用方式:                                                           │   │
│  │  claude -p --output-format stream-json --allowedTools "..." "prompt" │   │
│  │                                                                      │   │
│  │  返回结构:                                                           │   │
│  │  CLIResult {                                                         │   │
│  │    success: bool                                                     │   │
│  │    output: str              // 实际响应                              │   │
│  │    session_id: str          // 会话ID (用于多轮对话)                 │   │
│  │    parsed_output: dict      // 完整JSON响应                          │   │
│  │    execution_time: float    // 执行时间 (秒)                         │   │
│  │    total_cost: float        // API 调用成本 (USD)                    │   │
│  │  }                                                                   │   │
│  │                                                                      │   │
│  │  主要功能:                                                           │   │
│  │  • build_command() - 构建 Claude CLI 命令                            │   │
│  │  • execute() - 执行 CLI 并流式处理输出                               │   │
│  │  • execute_with_retry() - 带自动重试的执行                           │   │
│  │  • _handle_stream_event() - 处理流式事件                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  3.1 CLISession (会话管理器) 🆕 v1.7 新增                            │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  职责: 管理Claude Code CLI会话，保持跨阶段的LLM上下文               │   │
│  │                                                                      │   │
│  │  执行模式:                                                           │   │
│  │  ┌──────────────────┬───────────────────────────────────────────┐   │   │
│  │  │ SINGLE           │ 单次调用，无状态                           │   │   │
│  │  │ SESSION          │ 会话模式，通过 --resume 继续               │   │   │
│  │  └──────────────────┴───────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  │  会话生命周期:                                                       │   │
│  │  ┌──────────────────────────────────────────────────────────────┐   │   │
│  │  │  Phase 1: 规划         ──┐                                    │   │   │
│  │  │  Phase 2: 生成           │                                    │   │   │
│  │  │  Phase 3: 执行+自愈      ├──→  同一个 session_id               │   │   │
│  │  │    ├─ 自愈重试1          │     (通过 --resume 保持上下文)      │   │   │
│  │  │    ├─ 自愈重试2          │                                    │   │   │
│  │  │    └─ 自愈重试3        ──┘                                    │   │   │
│  │  └──────────────────────────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  │  流式事件类型:                                                       │   │
│  │  ┌──────────────────┬───────────────────────────────────────────┐   │   │
│  │  │ system           │ 会话初始化事件                             │   │   │
│  │  │ assistant        │ Claude回复 (含工具调用)                    │   │   │
│  │  │ user             │ 工具执行结果                               │   │   │
│  │  │ result           │ 最终结果和成本统计                         │   │   │
│  │  └──────────────────┴───────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  │  Todo更新机制:                                                       │   │
│  │  CLIAdapter 在处理 assistant 事件时，检测到 TodoWrite 工具调用      │   │
│  │  会触发 config.on_todo_update 回调，实时推送进度到 Web UI           │   │
│  │                                                                      │   │
│  │  主要功能:                                                           │   │
│  │  • start() - 启动新会话                                              │   │
│  │  • send() - 继续会话发送后续消息                                     │   │
│  │  • end() - 结束会话                                                  │   │
│  │  • get_history() - 获取会话历史                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  4. ResultJudge (结果仲裁器)                                         │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  职责: 判断测试结果，区分脚本错误和业务Bug                            │   │
│  │                                                                      │   │
│  │  判定逻辑:                                                           │   │
│  │  ┌────────────────┬─────────────────────────────────────────────┐   │   │
│  │  │ 执行失败       │ → 触发语法自愈 (Layer 1 Healing)             │   │   │
│  │  │ 执行成功+断言过│ → 测试通过                                   │   │   │
│  │  │ 执行成功+断言失败│ → 询问LLM判断是Bug还是断言写错              │   │   │
│  │  └────────────────┴─────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  5. WorkflowEngine (工作流引擎)                                      │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  职责: 驱动整个测试流程，管理状态机和自愈循环                         │   │
│  │                                                                      │   │
│  │  状态机:                                                             │   │
│  │  INIT → PLANNING → GENERATING → EXECUTING → HEALING → COMPLETED     │   │
│  │                                     ↑           │                    │   │
│  │                                     └───────────┘ (自愈循环)         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  6. PRDParser (PRD文档解析器) 🆕 v1.6 新增                          │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  职责: 解析各种格式的 PRD 文档，提取纯文本内容                       │   │
│  │                                                                      │   │
│  │  支持格式:                                                           │   │
│  │  ┌──────────────────┬───────────────────────────────────────────┐   │   │
│  │  │ .md / .markdown  │ Markdown 文档                              │   │   │
│  │  │ .docx            │ Word 文档 (依赖 python-docx)               │   │   │
│  │  │ .txt / .text     │ 纯文本文件                                 │   │   │
│  │  └──────────────────┴───────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  │  主要功能:                                                           │   │
│  │  • parse() - 解析 PRD 文档，返回纯文本                              │   │
│  │  • extract_sections() - 提取章节结构                                │   │
│  │  • summarize_for_prompt() - 生成供 Prompt 使用的摘要                │   │
│  │  • detect_business_keywords() - 检测业务关键词                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  7. DataLoader (测试数据加载器) 🆕 v1.6 新增                        │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  职责: 加载 Excel/CSV 测试数据，支持智能匹配                        │   │
│  │                                                                      │   │
│  │  支持格式:                                                           │   │
│  │  ┌──────────────────┬───────────────────────────────────────────┐   │   │
│  │  │ .xlsx            │ Excel 文件 (依赖 openpyxl)                 │   │   │
│  │  │ .csv             │ CSV 文件                                   │   │   │
│  │  └──────────────────┴───────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  │  主要功能:                                                           │   │
│  │  • load() - 加载数据文件                                            │   │
│  │  • load_multiple() - 批量加载多个文件                               │   │
│  │  • summarize_for_prompt() - 生成数据摘要供 LLM 使用                 │   │
│  │  • infer_api_mapping() - 推断数据与接口的映射关系                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  8. TestCaseParser (测试用例解析器) 🆕 v1.7 新增                    │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  职责: 解析 testcases.md，建立用例ID到用例详情的映射                 │   │
│  │                                                                      │   │
│  │  支持的用例ID格式:                                                   │   │
│  │  ┌──────────────────┬───────────────────────────────────────────┐   │   │
│  │  │ TC-XXX           │ 传统格式 (如 TC-001)                       │   │   │
│  │  │ API-XXX-YY       │ 接口测试用例 (如 API-001-01)               │   │   │
│  │  │ SCN-XXX          │ 场景测试用例 (如 SCN-001)                  │   │   │
│  │  │ RULE-XXX-YY      │ 规则验证用例 (如 RULE-001-01)              │   │   │
│  │  │ DATA-XXX-YY      │ 数据驱动用例 (如 DATA-001-01)              │   │   │
│  │  └──────────────────┴───────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  │  解析流程:                                                           │   │
│  │  testcases.md → 分割API节 → 解析表格行 → ParsedTestCase映射         │   │
│  │                                                                      │   │
│  │  输出数据结构:                                                       │   │
│  │  ParsedTestCase {                                                    │   │
│  │    testcase_id: str          // 用例ID                              │   │
│  │    api: str                  // 所属API                             │   │
│  │    scenario: str             // 测试场景                            │   │
│  │    priority: str             // 优先级 (P0/P1/P2)                   │   │
│  │    test_data: str            // 测试数据                            │   │
│  │    expected_result: str      // 预期结果                            │   │
│  │  }                                                                   │   │
│  │                                                                      │   │
│  │  主要功能:                                                           │   │
│  │  • parse() - 解析 testcases.md 返回用例映射                         │   │
│  │  • get_display_label() - 获取用例展示标签                           │   │
│  │  • extract_testcase_ids() - 从测试文件提取用例ID                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  9. SkeletonWriter (骨架文件生成器) 🆕 v1.7 新增                    │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  职责: 预生成固定的测试基础设施文件，避免LLM重复创建                 │   │
│  │                                                                      │   │
│  │  生成的文件:                                                         │   │
│  │  ┌──────────────────┬───────────────────────────────────────────┐   │   │
│  │  │ conftest.py      │ Pytest配置 + Session级Fixtures             │   │   │
│  │  │                  │ • BASE_URL, AUTH_TOKEN 配置               │   │   │
│  │  │                  │ • api_client fixture (HTTP会话)           │   │   │
│  │  │                  │ • explored_data fixture (探测数据)        │   │   │
│  │  │                  │ • get_explored_id() 辅助函数              │   │   │
│  │  ├──────────────────┼───────────────────────────────────────────┤   │   │
│  │  │ pytest.ini       │ Pytest运行配置                            │   │   │
│  │  │                  │ • timeout设置                             │   │   │
│  │  │                  │ • 标记定义 (p0, p1, p2)                   │   │   │
│  │  ├──────────────────┼───────────────────────────────────────────┤   │   │
│  │  │ requirements.txt │ 测试依赖列表                              │   │   │
│  │  │                  │ • requests, pytest, pytest-timeout        │   │   │
│  │  └──────────────────┴───────────────────────────────────────────┘   │   │
│  │                                                                      │   │
│  │  主要功能:                                                           │   │
│  │  • write() - 写入所有骨架文件                                       │   │
│  │  • _write_conftest() - 生成 conftest.py                             │   │
│  │  • _write_pytest_ini() - 生成 pytest.ini                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  10. DependencyExplorer (依赖探测器) 🆕 v1.7 新增                   │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  职责: 基于静态分析结果进行动态探测，获取真实可用的测试数据ID        │   │
│  │  启用条件: enable_exploration=True (默认关闭)                        │   │
│  │                                                                      │   │
│  │  探测流程:                                                           │   │
│  │  ┌─────────────────────────────────────────────────────────────┐    │   │
│  │  │  DependencyAnalysisResult (静态分析)                         │    │   │
│  │  │           │                                                  │    │   │
│  │  │           ▼                                                  │    │   │
│  │  │  按优先级排序接口 (入度为0的先执行)                          │    │   │
│  │  │           │                                                  │    │   │
│  │  │           ▼                                                  │    │   │
│  │  │  逐个调用接口 GET 方法                                       │    │   │
│  │  │     ├─ 提取响应中的 ID 字段                                  │    │   │
│  │  │     ├─ 记录提取结果                                          │    │   │
│  │  │     └─ 继续下一个                                            │    │   │
│  │  │           │                                                  │    │   │
│  │  │           ▼                                                  │    │   │
│  │  │  ExplorationResult                                           │    │   │
│  │  └─────────────────────────────────────────────────────────────┘    │   │
│  │                                                                      │   │
│  │  输出文件: explored_data.json                                        │   │
│  │  {                                                                   │   │
│  │    "overall_success": true,                                          │   │
│  │    "extracted_resources": {                                          │   │
│  │      "users": ["user_123", "user_456"],                              │   │
│  │      "templates": ["tmpl_001"]                                       │   │
│  │    }                                                                 │   │
│  │  }                                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  11. BusinessReportGenerator (业务报告生成器) 🆕 v1.7 新增          │   │
│  │  ────────────────────────────────────────────────────────────────── │   │
│  │  职责: 生成业务级HTML测试报告                                       │   │
│  │                                                                      │   │
│  │  报告特性:                                                           │   │
│  │  • 测试概览 (统计信息展示)                                          │   │
│  │  • 用例分类 (按状态分组: 通过/失败)                                 │   │
│  │  • 失败详情 (错误信息、证据)                                        │   │
│  │  • 响应式设计 (深色主题)                                            │   │
│  │                                                                      │   │
│  │  输出文件: business_report.html                                      │   │
│  │                                                                      │   │
│  │  主要功能:                                                           │   │
│  │  • generate() - 生成完整的业务报告                                   │   │
│  │  • _render_summary() - 渲染统计摘要                                  │   │
│  │  • _render_test_cases() - 渲染用例详情                               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 四、主流程：双重自愈工作流

### 4.1 流程概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              完整主流程                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                           用户输入                                    │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │ swagger.json│ │ 业务规则.md │ │ config.yaml │ │  data.md    │    │   │
│  │  │   (必填)    │ │   (可选)    │ │   (必填)    │ │   (可选)    │    │   │
│  │  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └──────┬──────┘    │   │
│  └─────────┼───────────────┼───────────────┼───────────────┼───────────┘   │
│            └───────────────┴───────┬───────┴───────────────┘               │
│                                    ▼                                        │
│                        ┌───────────────────────┐                            │
│                        │ 有业务规则? 自动判断   │                            │
│                        └───────────┬───────────┘                            │
│                             ╱            ╲                                  │
│                        有  ╱              ╲  无                             │
│                           ▼                ▼                                │
│                    ┌──────────┐      ┌──────────┐                          │
│                    │ 完整模式  │      │ 轻量模式  │                          │
│                    │ 业务+契约 │      │ 仅契约    │                          │
│                    └────┬─────┘      └────┬─────┘                          │
│                         └────────┬────────┘                                 │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐   │
│   │  Phase 1    →    Phase 2    →    Phase 3    →    Phase 4            │   │
│   │   规划            生成            执行+自愈        交付              │   │
│   │                                 ↑      │                             │   │
│   │                                 └──────┘ (自愈循环)                  │   │
│   └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │                           交付物                                      │   │
│  │  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐    │   │
│  │  │testcases.md │ │ test_*.py   │ │ report.html │ │bug_report   │    │   │
│  │  │ (测试用例)  │ │ (测试脚本)  │ │ (执行报告)  │ │  .json      │    │   │
│  │  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘    │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.1.1 三种测试模式 (v1.6 更新)

根据用户上传的文件组合，系统自动切换测试模式：

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          三种测试模式                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【模式 A: 接口测试模式 INTERFACE】仅 Swagger                               │
│  ─────────────────────────────────────────────────────────────────────────  │
│  输入: Swagger (必填)                                                       │
│                                                                             │
│  测试范围:                                                                  │
│  • 接口契约验证 (参数、响应结构)                                            │
│  • 基础可用性测试 (能调通、不报500)                                         │
│  • 参数边界测试 (空值、类型错误、必填校验)                                  │
│  • 依赖关系测试 (接口间的调用顺序)                                          │
│                                                                             │
│  数据来源: Swagger example + 动态探测                                       │
│  断言来源: Swagger 定义 + 通用规则                                          │
│  自愈策略: 仅语法自愈                                                       │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【模式 B: 业务测试模式 BUSINESS】Swagger + PRD                             │
│  ─────────────────────────────────────────────────────────────────────────  │
│  输入: Swagger + PRD 文档 (支持 .md / .docx / .txt)                         │
│                                                                             │
│  测试范围:                                                                  │
│  • 模式 A 全部能力                                                          │
│  • 业务场景流程测试 (从 PRD 自动识别)                                       │
│  • 业务规则断言 (从 PRD 自动提取)                                           │
│                                                                             │
│  数据来源: LLM 根据 PRD 业务描述自动构造测试数据                            │
│  断言来源: PRD 业务规则                                                     │
│  自愈策略: 语法自愈 + 逻辑自愈                                              │
│                                                                             │
│  LLM 智能理解:                                                              │
│  • 从 PRD 识别业务场景流程 → 生成 scenarios.json                            │
│  • 从 PRD 提取业务规则 → 生成 rules.json                                    │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【模式 C: 完整测试模式 COMPLETE】Swagger + PRD + 测试数据                  │
│  ─────────────────────────────────────────────────────────────────────────  │
│  输入: Swagger + PRD + 测试数据文件 (支持 .xlsx / .csv)                     │
│                                                                             │
│  测试范围:                                                                  │
│  • 模式 B 全部能力                                                          │
│  • 数据驱动测试 (使用上传的测试数据)                                        │
│                                                                             │
│  数据来源: 优先使用上传的测试数据，缺失部分自动补充                         │
│  断言来源: PRD 业务规则 + 测试数据期望值                                    │
│  自愈策略: 语法自愈 + 逻辑自愈                                              │
│                                                                             │
│  数据智能匹配:                                                              │
│  • LLM 自动将测试数据列名与接口参数匹配                                     │
│  • 生成 data_mapping.json 记录匹配关系                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

**模式自动判断逻辑:**

```python
@property
def test_mode(self) -> TestMode:
    has_prd = bool(self.prd_document and self.prd_document.strip())
    has_test_data = bool(self.test_data_files)

    if has_prd and has_test_data:
        return TestMode.COMPLETE    # 完整测试
    elif has_prd:
        return TestMode.BUSINESS    # 业务测试
    else:
        return TestMode.INTERFACE   # 接口测试
```

### 4.1.2 轻量模式测试策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      轻量模式测试策略                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  基于 Swagger 可推导的测试:                                                  │
│                                                                             │
│  1. 正向测试                                                                │
│     • 按 Swagger 示例值调用，期望返回定义的成功状态码                        │
│     • 验证响应结构符合 Swagger Schema                                       │
│                                                                             │
│  2. 参数验证测试                                                            │
│     • 必填参数缺失 → 期望 400                                               │
│     • 参数类型错误 (字符串传数字等) → 期望 400                              │
│     • 参数格式错误 (邮箱、手机号等) → 期望 400                              │
│                                                                             │
│  3. 认证测试 (如Swagger定义了security)                                      │
│     • 无Token → 期望 401                                                    │
│     • 错误Token → 期望 401/403                                              │
│                                                                             │
│  4. 依赖关系测试 (CLI自动分析接口间依赖)                                    │
│     • POST /order 依赖 POST /user (需要先有userId)                          │
│     • CLI自动识别依赖关系并按正确顺序测试                                   │
│                                                                             │
│  5. 通用健壮性测试                                                          │
│     • 不应返回 500 Internal Server Error                                    │
│     • 响应时间应在合理范围内                                                │
│     • 响应格式应符合 Content-Type                                           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Phase 1: 规划 (Planning)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Phase 1: 规划                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【输入】                                                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                         │
│  │ swagger.json│  │ 业务规则.md │  │  data.md    │                         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                         │
│         └────────────────┴───────────────┘                                  │
│                          │                                                  │
│                          ▼                                                  │
│  【执行】                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Driver 调用 CLI:                                                    │   │
│  │  "分析Swagger定义和业务规则，生成完整的测试用例文档"                  │   │
│  │                                                                      │   │
│  │  CLI 分析:                                                           │   │
│  │  • 解析 API 端点、参数、响应结构                                     │   │
│  │  • 结合业务规则推导测试场景                                          │   │
│  │  • 覆盖正常流程、边界条件、异常流程                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                          │                                                  │
│                          ▼                                                  │
│  【输出: testcases.md】 ← 持久化保存                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  # 测试用例文档                                                       │   │
│  │  > 生成时间: 2025-01-15 10:30:00                                     │   │
│  │  > 接口数量: 5                                                        │   │
│  │  > 用例总数: 23                                                       │   │
│  │                                                                      │   │
│  │  ## API: POST /api/v1/order                                          │   │
│  │                                                                      │   │
│  │  | 用例ID | 场景 | 前置条件 | 测试数据 | 预期结果 | 优先级 |          │   │
│  │  |--------|------|----------|----------|----------|--------|          │   │
│  │  | TC-001 | 正常下单 | 用户已登录 | SKU8892 | 200, order_id | P0 |    │   │
│  │  | TC-002 | 库存不足 | 用户已登录 | SKU0001 | 400, code=1002 | P0 |   │   │
│  │  | TC-003 | 未登录下单 | 无Token | - | 401 | P1 |                     │   │
│  │  | TC-004 | 参数缺失 | 用户已登录 | 缺少sku_id | 400, code=1001 | P1 │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【输出: context 数据】 ← 传递给 Phase 2 (v1.7 新增)                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  context.scenarios      → 业务场景列表 (从 PRD 识别)                  │   │
│  │  context.business_rules → 业务规则列表 (从 PRD 提取)                  │   │
│  │  context.data_mapping   → 测试数据映射 (Excel/CSV 与接口匹配)         │   │
│  │                                                                      │   │
│  │  这些数据会被注入到 Phase 2 的 Prompt 中，用于生成:                   │   │
│  │  • 场景测试代码 (test_scenario_*.py)                                  │   │
│  │  • 规则验证代码 (test_rule_*.py)                                      │   │
│  │  • 参数化测试代码 (test_data_*.py)                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.3 Phase 2: 生成 (Generation)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Phase 2: 生成                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【输入】                                                                    │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌──────────┐  │
│  │testcases.md│ │swagger.json│ │业务规则.md │ │config.yaml │ │ data.md  │  │
│  └─────┬──────┘ └─────┬──────┘ └─────┬──────┘ └─────┬──────┘ └────┬─────┘  │
│        └──────────────┴──────────────┴──────────────┴─────────────┘        │
│                                      │                                      │
│                                      ▼                                      │
│  【执行】                                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  Driver 调用 CLI:                                                    │   │
│  │  "根据测试用例文档生成Pytest代码"                                     │   │
│  │                                                                      │   │
│  │  约束要求:                                                           │   │
│  │  • 每个测试函数必须包含用例ID注释: # TestCase: TC-XXX               │   │
│  │  • 请求参数严格遵循Swagger定义                                       │   │
│  │  • 断言逻辑严格遵循业务规则                                          │   │
│  │  • 使用业务数据中的真实数据                                          │   │
│  │                                                                      │   │
│  │  PRD数据注入 (v1.7新增):                                             │   │
│  │  • scenarios_block: Phase 1 识别的业务场景 → 生成场景测试            │   │
│  │  • rules_block: Phase 1 提取的业务规则 → 生成规则验证测试            │   │
│  │  • data_mapping_block: 测试数据与接口映射 → 生成参数化测试           │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                      │                                      │
│                                      ▼                                      │
│  【输出: test_*.py】 ← 含用例ID注释标记                                     │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  import pytest                                                        │   │
│  │  import requests                                                      │   │
│  │                                                                      │   │
│  │  BASE_URL = "https://api.example.com"                                │   │
│  │                                                                      │   │
│  │  class TestOrderAPI:                                                  │   │
│  │      """订单接口测试"""                                               │   │
│  │                                                                      │   │
│  │      # TestCase: TC-001                                              │   │
│  │      def test_create_order_success(self):                            │   │
│  │          """正常下单"""                                               │   │
│  │          response = requests.post(                                   │   │
│  │              f"{BASE_URL}/api/v1/order",                             │   │
│  │              json={"sku_id": "SKU8892", "quantity": 1},              │   │
│  │              headers={"Authorization": "Bearer eyJ..."}              │   │
│  │          )                                                           │   │
│  │          assert response.status_code == 200                          │   │
│  │          assert "order_id" in response.json()                        │   │
│  │                                                                      │   │
│  │      # TestCase: TC-002                                              │   │
│  │      def test_create_order_no_stock(self):                           │   │
│  │          """库存不足"""                                               │   │
│  │          ...                                                         │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【用例与脚本的映射关系】                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  testcases.md                    test_order_api.py                   │   │
│  │  ─────────────                   ──────────────────                  │   │
│  │  TC-001  ────────────────────→   # TestCase: TC-001                  │   │
│  │                                  def test_create_order_success()     │   │
│  │                                                                      │   │
│  │  TC-002  ────────────────────→   # TestCase: TC-002                  │   │
│  │                                  def test_create_order_no_stock()    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【conftest.py 内容】                                                       │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  # conftest.py - Pytest 配置文件                                     │   │
│  │  # 配置值来源: Web UI 页面输入                                       │   │
│  │                                                                      │   │
│  │  import pytest                                                       │   │
│  │                                                                      │   │
│  │  # 环境配置 (从 config.yaml 读取)                                    │   │
│  │  BASE_URL = "https://api.example.com"                               │   │
│  │                                                                      │   │
│  │  # 认证信息 (从页面输入获取)                                         │   │
│  │  AUTH_TOKEN = "Bearer eyJ..."                                       │   │
│  │                                                                      │   │
│  │  @pytest.fixture                                                     │   │
│  │  def base_url():                                                     │   │
│  │      return BASE_URL                                                 │   │
│  │                                                                      │   │
│  │  @pytest.fixture                                                     │   │
│  │  def auth_headers():                                                 │   │
│  │      return {"Authorization": AUTH_TOKEN}                           │   │
│  │                                                                      │   │
│  │  @pytest.fixture                                                     │   │
│  │  def api_client(base_url, auth_headers):                            │   │
│  │      """通用 API 客户端"""                                           │   │
│  │      import requests                                                 │   │
│  │      session = requests.Session()                                   │   │
│  │      session.headers.update(auth_headers)                           │   │
│  │      return session                                                  │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.4 Phase 3: 执行 + 自愈 (Execution + Healing)

#### 4.4.1 核心概念

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            核心概念                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  执行粒度: 按文件执行 (pytest test_xxx.py)                                  │
│  测试粒度: 用例级别 (每个 test_xxx 函数 = 1个用例)                           │
│                                                                             │
│  测试结果只有两种:                                                          │
│  ┌─────────────┐                    ┌─────────────┐                        │
│  │   ✅ PASS   │                    │   ❌ FAIL   │                        │
│  │   用例通过   │                    │   用例失败   │                        │
│  └─────────────┘                    └─────────────┘                        │
│                                           │                                 │
│                               ┌───────────┴───────────┐                    │
│                               │      失败原因?         │                    │
│                               └───────────┬───────────┘                    │
│                                    ╱            ╲                           │
│                           脚本问题 ╱              ╲ 业务问题                 │
│                                  ╱                ╲                         │
│                                 ▼                  ▼                        │
│                          ┌──────────┐       ┌──────────┐                   │
│                          │ 可自愈    │       │ 真Bug    │                   │
│                          │ 修复后重试│       │ 记录失败  │                   │
│                          └──────────┘       └──────────┘                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 4.4.2 执行架构 (Driver 调用 pytest)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      执行架构: Driver 调 pytest + CLI 自愈                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【核心原则】                                                                │
│  • pytest 执行: 由 Driver 通过 subprocess 调用                              │
│  • 代码修复: 由 CLI 通过 Read/Edit 工具完成                                 │
│  • Driver 是指挥官，CLI 是特种兵                                            │
│                                                                             │
│  【执行流程】                                                                │
│                                                                             │
│   Driver                                          CLI                       │
│     │                                               │                       │
│     │ ① subprocess.run(pytest test_order.py)       │                       │
│     │────────────────────────────────────────→     │ (不参与)              │
│     │                                               │                       │
│     │ ② 解析结果 (JUnit XML)                        │                       │
│     │    ├─ 全部通过 → 下一个文件                   │                       │
│     │    └─ 有失败 → 逐个处理失败用例               │                       │
│     │                                               │                       │
│     │ ③ 调用 CLI 诊断/修复                          │                       │
│     │────────────────────────────────────────→     │                       │
│     │    发送: 错误信息 + 文件路径                  │ ④ Read 读取文件       │
│     │                                               │ ⑤ 分析错误原因        │
│     │                                               │ ⑥ Edit 修复代码       │
│     │ ⑦ CLI 返回修复结果                            │                       │
│     │←────────────────────────────────────────     │                       │
│     │                                               │                       │
│     │ ⑧ 重新执行 pytest (仅失败的用例)             │                       │
│     │    pytest test_order.py::test_xxx            │                       │
│     │                                               │                       │
│     │ ⑨ 循环直到: 通过 / 达到重试上限 / 确认是Bug   │                       │
│                                                                             │
│  【选择此架构的原因】                                                        │
│  • Driver 完全掌控流程，超时可控                                            │
│  • pytest 结果结构化 (JUnit XML)，易解析                                    │
│  • CLI 调用次数少，成本更优                                                 │
│  • 每次执行可单独记录日志                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 4.4.3 自愈流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          自愈流程                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                      Python Driver 执行 pytest                              │
│                               │                                             │
│                               ▼                                             │
│                      ┌────────────────┐                                     │
│                      │  用例执行结果   │                                     │
│                      └───────┬────────┘                                     │
│                              │                                              │
│              ┌───────────────┼───────────────┐                              │
│              │               │               │                              │
│              ▼               ▼               ▼                              │
│        ┌──────────┐   ┌──────────┐   ┌──────────┐                          │
│        │ 运行报错  │   │ 断言失败  │   │ 全部通过  │                          │
│        │ exit≠0   │   │ FAILED   │   │ PASSED   │                          │
│        └────┬─────┘   └────┬─────┘   └────┬─────┘                          │
│             │              │              │                                 │
│             ▼              ▼              ▼                                 │
│      ┌────────────┐  ┌────────────┐  ┌────────────┐                        │
│      │ 第一层自愈  │  │ 第二层自愈  │  │  完成 ✓    │                        │
│      │ 语法修复    │  │ 逻辑判断    │  │            │                        │
│      └─────┬──────┘  └─────┬──────┘  └────────────┘                        │
│            │               │                                                │
│            ▼               ▼                                                │
│     ┌─────────────────────────────────────────────────────┐                │
│     │                    CLI 诊断                          │                │
│     │                                                      │                │
│     │  Driver 发送给 CLI:                                  │                │
│     │  • 错误信息 (Traceback / AssertionError)             │                │
│     │  • 问题文件路径                                      │                │
│     │  • 业务规则 (用于逻辑判断)                           │                │
│     │                                                      │                │
│     │  CLI 返回:                                           │                │
│     │  • 已修复 → 重试执行                                 │                │
│     │  • 无法修复/确认是Bug → 记录失败，继续下一个用例     │                │
│     │                                                      │                │
│     └─────────────────────────────────────────────────────┘                │
│            │                                                                │
│            ▼                                                                │
│     ┌─────────────────────────────────────────────────────┐                │
│     │  重试 (最多3次)                                      │                │
│     │                                                      │                │
│     │  • 修复成功 → 重新执行该用例                         │                │
│     │  • 3次仍失败 → 标记失败，继续下一个用例              │                │
│     │                                                      │                │
│     └─────────────────────────────────────────────────────┘                │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 4.4.4 两层自愈机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          两层自愈机制                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【第一层: 语法自愈 Syntax Healing】                                         │
│  ─────────────────────────────────────────────────────────────────────────  │
│  触发: pytest 执行报错 (exit_code ≠ 0)                                      │
│                                                                             │
│  典型错误:                                                                  │
│  • SyntaxError      - 代码语法错误                                          │
│  • ImportError      - 模块导入失败                                          │
│  • NameError        - 变量未定义                                            │
│  • ConnectionError  - 请求地址错误                                          │
│  • TypeError        - 类型错误                                              │
│                                                                             │
│  处理方式:                                                                  │
│  1. Driver 捕获 Traceback                                                   │
│  2. Driver 调用 CLI: "这是错误信息，请读取文件并修复"                        │
│  3. CLI 使用 Read/Edit 工具修复代码                                         │
│  4. Driver 重新执行 pytest                                                  │
│                                                                             │
│  示例:                                                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  错误: NameError: name 'resposne' is not defined                    │   │
│  │  原因: 变量名拼写错误 (resposne → response)                          │   │
│  │  修复: CLI 自动修正拼写                                              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【第二层: 逻辑自愈 Logic Healing】                                          │
│  ─────────────────────────────────────────────────────────────────────────  │
│  触发: pytest 运行成功，但断言失败 (AssertionError)                         │
│                                                                             │
│  核心问题: 断言失败是"脚本写错"还是"真Bug"？                                 │
│                                                                             │
│  业务上下文来源 (v1.7 优先级):                                              │
│  1. context.business_rules → 优先使用 Phase 1 提取的结构化规则             │
│  2. context.prd_document   → 其次使用 PRD 原文 (截取前5000字符)            │
│  3. context.requirements   → 最后使用旧版 requirements 字段                │
│                                                                             │
│  处理方式:                                                                  │
│  1. Driver 捕获断言失败信息 (期望值 vs 实际值)                              │
│  2. Driver 调用 CLI: "对比业务规则，判断这是脚本问题还是真Bug"              │
│  3. CLI 分析后返回判断:                                                    │
│     • 脚本问题 → 修复断言，Driver 重试                                     │
│     • 真Bug → 不修复，Driver 记录失败                                      │
│                                                                             │
│  示例 A (脚本问题 - 可修复):                                                │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  断言: assert response.json()["user_id"] == "123"                   │   │
│  │  失败: KeyError: 'user_id'                                          │   │
│  │  实际: 响应字段名是 "userId" 不是 "user_id"                          │   │
│  │  判断: 脚本问题，字段名写错                                          │   │
│  │  处理: CLI 修正字段名，重试                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  示例 B (真Bug - 记录失败):                                                 │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  断言: assert response.status_code == 400  # 库存不足应返回400       │   │
│  │  失败: 实际返回 200                                                  │   │
│  │  业务规则: 库存不足时应返回 400 错误码                                │   │
│  │  判断: 真Bug，后端未校验库存                                         │   │
│  │  处理: 不修复，记录用例失败                                          │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 4.4.5 Session 复用策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Session 复用策略                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  整个测试流程使用同一个 CLI Session                                          │
│                                                                             │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │                          Session 生命周期                             │  │
│  │                                                                       │  │
│  │  Phase 1: 规划         ──┐                                           │  │
│  │  Phase 2: 生成           │                                           │  │
│  │  Phase 3: 执行+自愈      ├──→  同一个 session_id                      │  │
│  │    ├─ 自愈重试1          │                                           │  │
│  │    ├─ 自愈重试2          │                                           │  │
│  │    └─ 自愈重试3        ──┘                                           │  │
│  │                                                                       │  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
│  优势:                                                                      │
│  • CLI 记住之前生成的代码结构                                               │
│  • 自愈时能理解"我之前为什么这样写"                                         │
│  • 上下文连贯，修复更精准                                                   │
│                                                                             │
│  实现:                                                                      │
│  • 首次调用: claude -p --output-format json "prompt"                        │
│  • 后续调用: claude -p --output-format json --resume {session_id} "prompt"  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 4.4.6 自愈循环逻辑

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          自愈循环逻辑                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  对于每个测试用例:                                                          │
│                                                                             │
│     retry_count = 0                                                         │
│     max_retries = 3                                                         │
│                                                                             │
│     LOOP:                                                                   │
│        执行 pytest 该用例                                                   │
│        │                                                                    │
│        ├─ 通过 → 记录 PASS，下一个用例                                      │
│        │                                                                    │
│        └─ 失败 → 分析错误类型                                               │
│              │                                                              │
│              ├─ 运行报错 (语法/导入/连接等)                                 │
│              │     └─ 调用 CLI 修复                                         │
│              │           ├─ 修复成功 → retry_count++, 回到 LOOP             │
│              │           └─ 修复失败 → 记录 FAIL，下一个用例                │
│              │                                                              │
│              └─ 断言失败                                                    │
│                    └─ 调用 CLI 判断                                         │
│                          ├─ 脚本问题 → CLI修复, retry_count++, 回到 LOOP   │
│                          └─ 真Bug → 记录 FAIL，下一个用例                   │
│                                                                             │
│        如果 retry_count >= max_retries:                                     │
│           记录 FAIL，下一个用例                                             │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

#### 4.4.7 测试结果输出

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          测试结果输出                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  testcases.md (执行后更新)                                                  │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  | 用例ID | 场景 | 结果 | 失败原因 | 自愈次数 |                             │
│  |--------|------|------|----------|----------|                             │
│  | TC-001 | 正常下单 | ✅ PASS | - | 0 |                                    │
│  | TC-002 | 库存不足 | ❌ FAIL | 后端未校验库存 | 1 |                        │
│  | TC-003 | 未登录   | ✅ PASS | - | 2 |  ← 自愈2次后通过                   │
│  | TC-004 | 参数缺失 | ❌ FAIL | 达到最大重试次数 | 3 |                      │
│                                                                             │
│  统计: 通过 2 / 失败 2 / 共 4                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.5 Phase 4: 交付 (Finalization)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Phase 4: 交付                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  output/                                                                    │
│  ├── testcases.md              # 测试用例文档 (含执行状态)                   │
│  ├── tests/                                                                 │
│  │   ├── conftest.py           # Pytest配置                                 │
│  │   ├── test_order_api.py     # 测试脚本 (含 # TestCase: TC-XXX 标记)      │
│  │   └── test_user_api.py                                                   │
│  ├── reports/                                                               │
│  │   ├── report.html           # HTML可视化报告                             │
│  │   └── results.xml           # JUnit XML (CI/CD集成)                      │
│  └── bug_report.json           # Bug清单                                    │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【testcases.md 示例 (执行后更新)】                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  # 测试用例文档                                                       │   │
│  │                                                                      │   │
│  │  > 项目: 电商订单系统                                                 │   │
│  │  > 生成时间: 2025-01-15 10:30:00                                     │   │
│  │  > 执行时间: 2025-01-15 10:35:22                                     │   │
│  │  > 用例总数: 23                                                       │   │
│  │  > 执行结果: 通过 20 / 失败 2 / Bug 1                                 │   │
│  │                                                                      │   │
│  │  ## POST /api/v1/order                                               │   │
│  │                                                                      │   │
│  │  | ID | 场景 | 状态 | 关联脚本 |                                      │   │
│  │  |----|------|------|----------|                                      │   │
│  │  | TC-001 | 正常下单 | ✅ PASS | test_order_api.py:15 |              │   │
│  │  | TC-002 | 库存不足 | 🐛 BUG | test_order_api.py:28 |               │   │
│  │  | TC-003 | 未登录   | ✅ PASS | test_order_api.py:41 |              │   │
│  │                                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【bug_report.json 示例】                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  {                                                                    │   │
│  │    "summary": { "total": 1, "high": 1, "medium": 0, "low": 0 },      │   │
│  │    "bugs": [                                                         │   │
│  │      {                                                               │   │
│  │        "testcase_id": "TC-002",                                      │   │
│  │        "api": "POST /api/v1/order",                                  │   │
│  │        "scenario": "库存不足下单",                                    │   │
│  │        "expected": "返回400, code=1002",                             │   │
│  │        "actual": "返回200, 创建了订单",                               │   │
│  │        "severity": "HIGH",                                           │   │
│  │        "root_cause": "后端未校验库存",                                │   │
│  │        "evidence": { "request": {...}, "response": {...} }           │   │
│  │      }                                                               │   │
│  │    ]                                                                 │   │
│  │  }                                                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.6 可选: 压力测试 (Load Testing) - v1.7 新增

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       可选: 压力测试 (基于 Locust)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【触发条件】                                                               │
│  用户在 Web UI 勾选"执行压力测试"选项后触发                                 │
│                                                                             │
│  【智能筛选 (v1.7 新增)】                                                   │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  1. 解析 Phase 3 产生的 results.xml (JUnit 格式)                     │   │
│  │  2. 提取通过/失败的接口列表                                          │   │
│  │  3. 根据配置筛选压测目标:                                            │   │
│  │     • only_passed=True → 仅压测功能测试通过的接口                    │   │
│  │     • target_endpoints=[...] → 压测指定接口                          │   │
│  │     • 默认 → 压测所有接口                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【执行流程】                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  1. LoadTestRunner 解析功能测试结果                                   │   │
│  │  2. 构建 Prompt，调用 CLI 生成 locustfile.py                         │   │
│  │  3. 执行 Locust 压测 (headless 模式)                                 │   │
│  │  4. 收集压测报告 (HTML + CSV)                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  【输出】                                                                   │
│  output/                                                                    │
│  └── load_test/                                                            │
│      ├── locustfile.py          # 生成的压测脚本                            │
│      ├── load_test_report.html  # 压测报告                                  │
│      └── load_test_stats.csv    # 压测统计数据                              │
│                                                                             │
│  【配置参数】                                                               │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  LoadTestConfig:                                                      │   │
│  │    concurrent_users: 10      # 并发用户数                             │   │
│  │    spawn_rate: 1             # 用户生成速率 (每秒)                    │   │
│  │    duration: 60              # 压测持续时间 (秒)                      │   │
│  │    only_passed: True         # 仅压测通过的接口                       │   │
│  │    target_endpoints: []      # 指定接口列表 (可选)                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、数据流：骨架与灵魂融合

### 5.1 输入数据流（四层结构）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           输入数据流                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│   │  1. 骨架    │  │  2. 灵魂    │  │  3. 环境    │  │  4. 数据    │       │
│   │  Skeleton   │  │  Soul       │  │  Config     │  │  Data       │       │
│   ├─────────────┤  ├─────────────┤  ├─────────────┤  ├─────────────┤       │
│   │ swagger.json│  │ 业务规则    │  │ config.yaml │  │ data.md     │       │
│   │ OpenAPI     │  │ 断言条件    │  │ base_url    │  │             │       │
│   │             │  │             │  │ token       │  │             │       │
│   ├─────────────┤  ├─────────────┤  ├─────────────┤  ├─────────────┤       │
│   │   必填 ✓    │  │   可选 ○    │  │   必填 ✓    │  │   可选 ○    │       │
│   └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘       │
│          │               │               │               │                 │
│    Grounding       Oracle         Runtime         Fixtures                 │
│    (结构约束)      (逻辑裁判)     (运行依赖)      (测试数据)                │
│          │               │               │               │                 │
│          └───────────────┴───────┬───────┴───────────────┘                 │
│                                  │                                          │
│                                  ▼                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                       Prompt 组装                                    │  │
│   │                                                                      │  │
│   │   ## 骨架 (Swagger)                                                  │  │
│   │   {swagger_content}                                                  │  │
│   │                                                                      │  │
│   │   ## 灵魂 (业务规则) - 可选                                          │  │
│   │   {requirements_content or "无业务规则，使用轻量模式测试"}           │  │
│   │                                                                      │  │
│   │   ## 环境配置                                                        │  │
│   │   base_url: {config.base_url}                                        │  │
│   │                                                                      │  │
│   │   ## 业务数据 (如有)                                                 │  │
│   │   {data_md_content or "无预置数据，请使用Swagger示例值"}             │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 业务数据层详解

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        业务数据层 (Data Layer)                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ● 解决的问题                                                               │
│  ─────────────────────────────────────────────────────────────────────────  │
│  • AI幻觉: 防止Agent编造不存在的SKU、用户ID等                               │
│  • 数据依赖: 提供真实有效的测试账号、商品数据                                │
│  • 特殊场景: 白名单账号、VIP账号、灰度用户等                                 │
│                                                                             │
│  ● 设计原则                                                                 │
│  ─────────────────────────────────────────────────────────────────────────  │
│  • 可选输入: 不是必填项，无数据时Agent使用Swagger示例值                      │
│  • 单文件: MVP阶段只支持1个data.md文件                                      │
│  • 原样传递: 不做预解析，直接嵌入Prompt由CLI智能理解                         │
│  • 智能匹配: Agent根据测试场景自行选择合适的数据                             │
│  • 用户自理: 敏感数据(Token/密码)由用户自行管理                              │
│                                                                             │
│  ● 数据文档示例 (data.md)                                                   │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   ## 测试账号                                                               │
│   | 账号ID | 类型 | 说明 | Token |                                         │
│   |--------|------|------|-------|                                         │
│   | U001 | VIP | VIP专属功能测试 | Bearer eyJ... |                         │
│   | U002 | Normal | 普通用户测试 | Bearer eyJ... |                         │
│   | U003 | Blacklist | 黑名单用户 | Bearer eyJ... |                        │
│                                                                             │
│   ## 商品SKU                                                                │
│   | SKU | 库存 | 说明 |                                                     │
│   |-----|------|------|                                                     │
│   | SKU8892 | 100 | 有库存，正常下单测试 |                                  │
│   | SKU0001 | 0 | 无库存，库存不足测试 |                                    │
│                                                                             │
│  ● 处理流程                                                                 │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   data.md ──→ 原样嵌入Prompt ──→ CLI智能解析 ──→ 生成代码时选用             │
│                                       │                                     │
│                                       ▼                                     │
│                              根据场景自动匹配:                               │
│                              • 测试VIP功能 → 选择U001                       │
│                              • 测试库存不足 → 选择SKU0001                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 输出数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           输出数据流                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                        测试资产 (Test Assets)                      │    │
│   ├───────────────────────────────────────────────────────────────────┤    │
│   │                                                                   │    │
│   │   tests/                                                          │    │
│   │   ├── conftest.py          # Pytest fixtures                      │    │
│   │   ├── test_user_api.py     # 用户模块测试                         │    │
│   │   ├── test_order_api.py    # 订单模块测试                         │    │
│   │   └── data/                                                       │    │
│   │       └── test_data.json   # 测试数据                             │    │
│   │                                                                   │    │
│   │   特点:                                                           │    │
│   │   • 可直接 pytest 运行                                            │    │
│   │   • 可提交 Git 归档                                               │    │
│   │   • 包含完整 Setup/Teardown                                       │    │
│   │                                                                   │    │
│   └───────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                        执行报告 (Reports)                          │    │
│   ├───────────────────────────────────────────────────────────────────┤    │
│   │                                                                   │    │
│   │   reports/                                                        │    │
│   │   ├── report.html          # 可视化测试报告                       │    │
│   │   ├── results.xml          # JUnit 格式 (CI/CD集成)               │    │
│   │   └── run.log              # 完整执行日志                         │    │
│   │                                                                   │    │
│   └───────────────────────────────────────────────────────────────────┘    │
│                                                                             │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                        Bug洞察 (Insights)                          │    │
│   ├───────────────────────────────────────────────────────────────────┤    │
│   │                                                                   │    │
│   │   bug_report.json                                                 │    │
│   │   {                                                               │    │
│   │     "total_bugs": 2,                                              │    │
│   │     "bugs": [                                                     │    │
│   │       {                                                           │    │
│   │         "api": "POST /order",                                     │    │
│   │         "scenario": "库存不足下单",                               │    │
│   │         "expected": "返回错误码 1002",                            │    │
│   │         "actual": "返回 200 成功",                                │    │
│   │         "severity": "HIGH",                                       │    │
│   │         "root_cause": "后端未校验库存"                            │    │
│   │       }                                                           │    │
│   │     ]                                                             │    │
│   │   }                                                               │    │
│   │                                                                   │    │
│   └───────────────────────────────────────────────────────────────────┘    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 六、技术选型

| 层次 | 组件 | 技术选型 | 说明 |
|------|------|----------|------|
| **表现层** | 框架 | Flask / FastAPI (可选) | 轻量级Web框架 |
| | 前端 | HTML + TailwindCSS + Vanilla JS | 快速原型，低依赖 |
| | 通信 | REST API / WebSocket | 实时日志推送 |
| **编排层** | 语言 | Python 3.10+ | 主控语言 |
| | 进程通信 | subprocess | 非交互模式调用CLI |
| | 配置解析 | PyYAML / Pydantic | 结构化配置 |
| | API解析 | openapi-spec-validator | Swagger解析 |
| | 日志 | logging + rich | 美化输出 |
| | PRD解析 | python-docx | Word文档解析 (v1.6 新增) |
| | 数据加载 | openpyxl | Excel文件解析 (v1.6 新增) |
| **执行层** | LLM引擎 | Claude Code CLI (主) | 代码生成与执行 |
| | | Codex CLI (备选) | 备用引擎 |
| | 通信协议 | `-p --output-format json` | 非交互JSON输出 |
| **产出层** | 测试框架 | Pytest + pytest-html | 行业标准 |
| | 报告格式 | HTML / JUnit XML | 可视化 + CI集成 |
| | 版本控制 | Git | 测试资产归档 |

---

## 七、接口定义（组件间通信）

### 7.1 数据结构定义

```python
# 1. InputParser 输出
class TaskContext:
    swagger: SwaggerSpec        # 解析后的Swagger
    requirements: List[Rule]    # 业务规则列表
    config: EnvConfig           # 环境配置
    target_apis: List[str]      # 待测试的API列表 (可选过滤)

# 2. PromptBuilder 输出
class PromptPackage:
    prompt: str                 # 主Prompt
    context_files: List[str]    # 需要CLI读取的文件路径
    allowed_tools: List[str]    # 允许CLI使用的工具
    expected_output: str        # 期望的输出类型描述

# 3. CLIAdapter 输出 ✅ 已实现
class CLIResult:
    success: bool               # 是否成功
    output: str                 # 响应内容
    session_id: str             # 会话ID
    exit_code: int              # 退出码
    execution_time: float       # 执行时间
    parsed_output: dict         # 完整JSON (含cost等)

# 4. ResultJudge 输出
class JudgeResult:
    verdict: Verdict            # PASS / SCRIPT_ERROR / BUG_FOUND
    need_healing: bool          # 是否需要自愈
    healing_type: HealingType   # SYNTAX / LOGIC
    error_detail: str           # 错误详情
    bug_report: BugReport       # Bug报告 (如果是Bug)

# 5. WorkflowEngine 状态
class WorkflowState(Enum):
    INIT        = "初始化"
    PLANNING    = "规划测试场景"
    GENERATING  = "生成测试代码"
    EXECUTING   = "执行测试"
    HEALING     = "自愈修复中"
    VALIDATING  = "逻辑验证中"
    COMPLETED   = "已完成"
    FAILED      = "失败"

# 6. 依赖分析数据模型 (src/models/dependency.py)

# 6.1 接口端点引用
class EndpointRef:
    method: str                 # HTTP方法 (GET/POST/PUT/DELETE)
    path: str                   # 接口路径 (/api/users/{id})
    operationId: str            # Swagger operationId (可选)

# 6.2 字段引用
class FieldRef:
    name: str                   # 字段名 (userId, templateId)
    location: str               # 位置: path/query/body/header

# 6.3 资源信息
class ResourceInfo:
    name: str                   # 资源名称 (users, templates)
    id_field: str               # ID字段名 (id, userId)
    list_endpoint: EndpointRef  # 列表接口 (GET /api/users)
    create_endpoint: EndpointRef# 创建接口 (POST /api/users)
    dependencies: List[str]     # 依赖的其他资源

# 6.4 依赖链接
class DependencyLink:
    consumer: EndpointRef       # 消费者接口 (依赖者)
    field: FieldRef             # 消费字段
    producers: List[EndpointRef]# 可能的生产者接口列表
    normalized_id: str          # 归一化ID (templateId等)
    confidence: str             # 置信度: "最高"|"高"|"中"|"低"
    reason: str                 # 分析依据

# 置信度来源:
# ┌──────────────────┬───────────────────────────────────────────┐
# │ 最高             │ 显式声明: [依赖], x-depends 扩展字段        │
# │ 高               │ 路径参数 + 字段名匹配                       │
# │ 中               │ 语义关键词推断 (creatorId→userId)          │
# │ 低               │ 仅字段名相似                                │
# └──────────────────┴───────────────────────────────────────────┘

# 6.5 依赖分析结果
class DependencyAnalysisResult:
    resources: Dict[str, ResourceInfo]  # 资源映射
    dependencies: List[DependencyLink]  # 依赖链列表
    sorted_endpoints: List[str]         # 拓扑排序后的接口清单

    def to_prompt_block(self) -> str:
        """生成Prompt友好的摘要文本"""
        pass

# 7. 错误信息结构 (src/models/result.py)
class ErrorInfo:
    error_type: ErrorType       # SYNTAX/ASSERTION/CONNECTION/UNKNOWN
    message: str                # 错误消息
    file_path: str              # 出错文件
    line_number: int            # 出错行号
    traceback: str              # 完整堆栈

class ErrorType(Enum):
    SYNTAX      = "syntax"      # 语法错误 (SyntaxError, NameError)
    ASSERTION   = "assertion"   # 断言失败 (AssertionError)
    CONNECTION  = "connection"  # 连接错误 (ConnectionError, Timeout)
    UNKNOWN     = "unknown"     # 未知错误
```

### 7.2 CLI 调用协议

```bash
# Claude Code CLI 调用格式
claude -p --output-format json --allowedTools "Read,Write,Edit" "your prompt"

# 返回 JSON 结构
{
  "type": "result",
  "subtype": "success",
  "is_error": false,
  "result": "实际响应内容",
  "session_id": "uuid",
  "duration_ms": 9321,
  "total_cost_usd": 0.01715
}
```

### 7.3 分阶段权限配置 (allowedTools)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      分阶段 CLI 权限配置                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【原则】权限最小化，给足但不多给                                            │
│                                                                             │
│  ┌──────────────┬─────────────────────┬─────────────────────────────────┐  │
│  │ Phase        │ allowedTools        │ 说明                            │  │
│  ├──────────────┼─────────────────────┼─────────────────────────────────┤  │
│  │ Phase 1      │ Read, Write         │ 读取输入文件，写入testcases.md  │  │
│  │ 规划         │                     │                                 │  │
│  ├──────────────┼─────────────────────┼─────────────────────────────────┤  │
│  │ Phase 2      │ Read, Write         │ 读取规划文件，写入test_*.py    │  │
│  │ 生成         │                     │ 写入conftest.py                │  │
│  ├──────────────┼─────────────────────┼─────────────────────────────────┤  │
│  │ Phase 3      │ Read, Edit          │ 读取测试文件，修复代码          │  │
│  │ 自愈         │                     │ 不需要Write(不创建新文件)      │  │
│  ├──────────────┼─────────────────────┼─────────────────────────────────┤  │
│  │ Phase 4      │ Read, Write         │ 读取结果，生成报告文件          │  │
│  │ 交付         │                     │                                 │  │
│  └──────────────┴─────────────────────┴─────────────────────────────────┘  │
│                                                                             │
│  【注意】                                                                    │
│  • pytest 由 Driver 调用，CLI 不需要 Bash 权限                              │
│  • 自愈阶段用 Edit 而非 Write，只修改不新建                                 │
│  • 所有阶段都需要 Read 权限读取上下文                                       │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.4 Prompt 模板体系

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Prompt 模板体系                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【模板文件结构】(7个模板)                                                   │
│  ─────────────────────────────────────────────────────────────────────────  │
│  templates/                                                                 │
│  ├── plan_prompt.txt           # Phase 1: 接口模式规划 (仅Swagger)          │
│  ├── business_plan_prompt.txt  # Phase 1: 业务模式规划 (Swagger+PRD+数据)   │
│  ├── generate_prompt.txt       # Phase 2: 测试代码生成                      │
│  ├── heal_syntax_prompt.txt    # Phase 3: 语法自愈                          │
│  ├── heal_logic_prompt.txt     # Phase 3: 逻辑自愈                          │
│  ├── finalize_prompt.txt       # Phase 4: 交付整理                          │
│  └── load_test_prompt.txt      # 压测脚本生成 (Locust)                      │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【构建流程】                                                                │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   模板文件                  PromptBuilder                CLI调用            │
│  ┌──────────┐            ┌─────────────────┐          ┌──────────┐         │
│  │ .txt模板 │ ──读取──→  │ 填充动态变量     │ ──组装──→ │ 完整Prompt│         │
│  └──────────┘            │ {swagger}       │          └──────────┘         │
│                          │ {requirements}  │                               │
│                          │ {testcases}     │                               │
│                          │ {traceback}     │                               │
│                          └─────────────────┘                               │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【各阶段Prompt说明】                                                        │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  ┌──────────┬────────────────────────┬─────────────────────┬──────────────┐│
│  │ Phase    │ 模板                   │ 输入变量            │ 输出         ││
│  ├──────────┼────────────────────────┼─────────────────────┼──────────────┤│
│  │ 规划     │ plan_prompt.txt        │ swagger             │ testcases.md ││
│  │ (接口)   │                        │ dependency_block    │              ││
│  ├──────────┼────────────────────────┼─────────────────────┼──────────────┤│
│  │ 规划     │ business_plan_prompt   │ swagger             │ testcases.md ││
│  │ (业务)   │                        │ requirements        │ analysis.json││
│  │          │                        │ data                │ test_data.csv││
│  │          │                        │ dependency_block    │              ││
│  ├──────────┼────────────────────────┼─────────────────────┼──────────────┤│
│  │ 生成     │ generate_prompt.txt    │ testcases           │ test_*.py    ││
│  │          │                        │ swagger             │ conftest.py  ││
│  │          │                        │ config              │              ││
│  │          │                        │ explored_data       │              ││
│  ├──────────┼────────────────────────┼─────────────────────┼──────────────┤│
│  │ 语法自愈 │ heal_syntax_prompt     │ traceback           │ 修复后代码   ││
│  │          │                        │ current_code        │              ││
│  ├──────────┼────────────────────────┼─────────────────────┼──────────────┤│
│  │ 逻辑自愈 │ heal_logic_prompt      │ expected            │ 判定+修复    ││
│  │          │                        │ actual              │ 或Bug报告    ││
│  │          │                        │ requirements        │              ││
│  ├──────────┼────────────────────────┼─────────────────────┼──────────────┤│
│  │ 压测生成 │ load_test_prompt       │ swagger             │ locustfile.py││
│  │          │                        │ target_apis         │              ││
│  │          │                        │ config              │              ││
│  └──────────┴────────────────────────┴─────────────────────┴──────────────┘│
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【模板选择逻辑】                                                            │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  TestMode判断:                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐  │
│  │ 输入组合                          → 测试模式    → 规划模板             │  │
│  ├──────────────────────────────────────────────────────────────────────┤  │
│  │ Swagger only                     → INTERFACE   → plan_prompt.txt     │  │
│  │ Swagger + PRD                    → BUSINESS    → business_plan_prompt│  │
│  │ Swagger + PRD + 测试数据          → COMPLETE    → business_plan_prompt│  │
│  └──────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【模板示例: plan_prompt.txt】                                               │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  你是API测试专家，请分析以下内容，生成完整的测试用例文档。                     │
│                                                                             │
│  ## Swagger定义                                                             │
│  {swagger_content}                                                          │
│                                                                             │
│  ## 业务规则                                                                │
│  {requirements_content}                                                     │
│                                                                             │
│  ## 业务数据（如有）                                                        │
│  {data_content}                                                             │
│                                                                             │
│  请按以下Markdown格式输出测试用例文档：                                      │
│  - 用例ID格式: TC-XXX                                                       │
│  - 包含: 场景、前置条件、测试数据、预期结果、优先级                          │
│  - 覆盖: 正常流程、边界条件、异常流程                                        │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【模板示例: heal_logic_prompt.txt】                                         │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  断言失败，请判断是代码问题还是业务Bug。                                      │
│                                                                             │
│  ## 断言详情                                                                │
│  用例ID: {testcase_id}                                                      │
│  期望值: {expected}                                                         │
│  实际值: {actual}                                                           │
│                                                                             │
│  ## 业务规则                                                                │
│  {requirements}                                                             │
│                                                                             │
│  请判断：                                                                   │
│  A. 断言写错了 → 修正断言代码                                               │
│  B. 发现业务Bug → 输出Bug报告(JSON格式)                                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.5 错误信息传递格式

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      Driver → CLI 错误信息传递格式                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【来源】Driver 解析 pytest JUnit XML 和 stdout                              │
│                                                                             │
│  【语法错误传递】                                                            │
│  ─────────────────────────────────────────────────────────────────────────  │
│  {                                                                          │
│    "error_type": "SyntaxError",      // NameError, ImportError, TypeError  │
│    "file": "tests/test_order_api.py",                                      │
│    "function": "test_create_order_success",                                │
│    "testcase_id": "TC-001",          // 从注释中提取                        │
│    "line": 28,                                                              │
│    "message": "NameError: name 'resposne' is not defined",                 │
│    "traceback": "Traceback (most recent call last):\n  File..."            │
│  }                                                                          │
│                                                                             │
│  【断言失败传递】                                                            │
│  ─────────────────────────────────────────────────────────────────────────  │
│  {                                                                          │
│    "error_type": "AssertionError",                                         │
│    "file": "tests/test_order_api.py",                                      │
│    "function": "test_create_order_no_stock",                               │
│    "testcase_id": "TC-002",                                                │
│    "assertion": "assert response.status_code == 400",                      │
│    "expected": "400",                                                       │
│    "actual": "200",                                                         │
│    "response_body": {"code": 0, "message": "success", "order_id": "..."}  │
│  }                                                                          │
│                                                                             │
│  【Driver 解析来源】                                                         │
│  ─────────────────────────────────────────────────────────────────────────  │
│  • pytest --junitxml=result.xml    → 结构化测试结果                         │
│  • pytest stdout/stderr            → Traceback 详情                         │
│  • test_*.py 文件                   → 提取 # TestCase: TC-XXX 注释         │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.6 超时处理策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          超时处理策略                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【整体策略】暂不设置整体超时，按单元控制                                    │
│                                                                             │
│  ┌──────────────────┬───────────┬─────────────────────────────────────────┐│
│  │ 超时类型         │ 超时时间  │ 处理方式                                ││
│  ├──────────────────┼───────────┼─────────────────────────────────────────┤│
│  │ 单个测试用例执行 │ 120秒     │ 超时后标记 TIMEOUT，记录日志，继续下个  ││
│  ├──────────────────┼───────────┼─────────────────────────────────────────┤│
│  │ CLI 单次调用     │ 180秒     │ 超时后重试，连续3次超时则报错终止       ││
│  ├──────────────────┼───────────┼─────────────────────────────────────────┤│
│  │ 整体流程         │ 不设置    │ MVP阶段暂不限制                          ││
│  └──────────────────┴───────────┴─────────────────────────────────────────┘│
│                                                                             │
│  【超时日志示例】                                                            │
│  ─────────────────────────────────────────────────────────────────────────  │
│  [10:35:21] ⚠ TC-005: test_large_order 执行超时 (120s)                     │
│  [10:35:21]   原因: 可能接口响应慢或测试数据量大                            │
│  [10:35:21]   处理: 标记 TIMEOUT，跳过自愈，继续下一用例                    │
│                                                                             │
│  [10:38:45] ⚠ CLI 调用超时 (第1次/共3次)                                   │
│  [10:38:45]   正在重试...                                                   │
│  [10:41:12] ⚠ CLI 调用超时 (第2次/共3次)                                   │
│  [10:41:12]   正在重试...                                                   │
│  [10:43:38] ✗ CLI 连续超时3次，终止执行                                    │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 八、实时日志系统

### 8.1 日志展示设计

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Web UI 日志面板                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                      执行日志 (实时更新)                               │  │
│  │                                                                        │  │
│  │  [10:30:01] ▶ Phase 1: 规划                                           │  │
│  │  [10:30:01]   读取 Swagger 文件: api.json                             │  │
│  │  [10:30:02]   读取业务规则: rules.md (或: 未提供，使用轻量模式)        │  │
│  │  [10:30:02]   调用 CLI 分析接口...                                    │  │
│  │  [10:30:05]   发现 5 个 API 端点                                      │  │
│  │  [10:30:07]   生成 23 个测试用例                                      │  │
│  │  [10:30:08]   保存用例文档: testcases.md                              │  │
│  │  [10:30:08] ✓ Phase 1 完成 (耗时 7s)                                  │  │
│  │                                                                        │  │
│  │  [10:30:09] ▶ Phase 2: 生成                                           │  │
│  │  [10:30:09]   调用 CLI 生成测试代码...                                │  │
│  │  [10:30:12]   生成 test_order_api.py (12 个用例)                      │  │
│  │  [10:30:15]   生成 test_user_api.py (11 个用例)                       │  │
│  │  [10:30:17]   生成 conftest.py                                        │  │
│  │  [10:30:18] ✓ Phase 2 完成 (耗时 9s)                                  │  │
│  │                                                                        │  │
│  │  [10:30:19] ▶ Phase 3: 执行                                           │  │
│  │  [10:30:19]   执行测试用例 (共 23 个)                                 │  │
│  │  [10:30:19]   ├─ TC-001: 正常下单                                     │  │
│  │  [10:30:21]   │  ✓ PASS (1.8s)                                        │  │
│  │  [10:30:21]   ├─ TC-002: 库存不足                                     │  │
│  │  [10:30:23]   │  ✗ 断言失败                                           │  │
│  │  [10:30:23]   │  → 触发逻辑自愈 (第1次)                               │  │
│  │  [10:30:25]   │  → CLI判定: 真Bug，后端未校验库存                     │  │
│  │  [10:30:25]   │  ✗ FAIL                                               │  │
│  │  [10:30:25]   ├─ TC-003: 未登录下单                                   │  │
│  │  [10:30:27]   │  ✗ 运行报错: NameError                                │  │
│  │  [10:30:27]   │  → 触发语法自愈 (第1次)                               │  │
│  │  [10:30:29]   │  → CLI修复: 变量名拼写错误                            │  │
│  │  [10:30:29]   │  → 重试执行...                                        │  │
│  │  [10:30:31]   │  ✓ PASS (自愈1次)                                     │  │
│  │  [10:30:31]   └─ ...                                                  │  │
│  │  [10:31:45] ✓ Phase 3 完成 (通过 20 / 失败 3)                         │  │
│  │                                                                        │  │
│  │  [10:31:46] ▶ Phase 4: 交付                                           │  │
│  │  [10:31:46]   生成 HTML 报告: report.html                             │  │
│  │  [10:31:47]   更新用例文档: testcases.md                              │  │
│  │  [10:31:47]   生成 Bug 报告: bug_report.json (3 个 Bug)               │  │
│  │  [10:31:48] ✓ Phase 4 完成                                            │  │
│  │  [10:31:48] ══════════════════════════════════════════════════════════│  │
│  │  [10:31:48] 执行完成！通过率: 87% (20/23)                             │  │
│  │                                                                        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 日志级别

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          日志级别                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Level 1: 阶段日志 (Phase)                                                  │
│  ─────────────────────────────────────────────────────────────────────────  │
│  ▶ Phase 1: 规划                                                            │
│  ✓ Phase 1 完成 (耗时 8s)                                                   │
│  ▶ Phase 2: 生成                                                            │
│  ...                                                                        │
│                                                                             │
│  Level 2: 步骤日志 (Step)                                                   │
│  ─────────────────────────────────────────────────────────────────────────  │
│  正在分析 Swagger 文件...                                                   │
│  发现 5 个 API 端点                                                         │
│  生成 23 个测试用例                                                         │
│  执行 TC-001: 正常下单...                                                   │
│                                                                             │
│  Level 3: 详细日志 (Detail)                                                 │
│  ─────────────────────────────────────────────────────────────────────────  │
│  [CLI] 调用: claude -p --output-format json "..."                           │
│  [CLI] 响应: {"result": "...", "session_id": "xxx"}                         │
│  [Pytest] exit_code=0, 耗时 1.2s                                            │
│  [自愈] 分析错误: NameError at line 28                                      │
│                                                                             │
│  默认展示: 全部级别                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.3 技术实现方案

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          实时日志实现方案                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【技术方案: WebSocket 推送】                                                │
│                                                                             │
│   Python Driver                    Web Server                  Browser      │
│        │                               │                          │         │
│        │ emit("log", {...})            │                          │         │
│        │ ─────────────────────────────>│                          │         │
│        │                               │ ws.send(log)             │         │
│        │                               │ ────────────────────────>│         │
│        │                               │                          │ 渲染日志 │
│        │                               │                          │         │
│                                                                             │
│  【日志数据结构】                                                            │
│  ─────────────────────────────────────────────────────────────────────────  │
│  {                                                                          │
│    "timestamp": "2025-01-15T10:30:01.123Z",                                 │
│    "level": "step",           // phase | step | detail                      │
│    "phase": "planning",       // planning | generation | execution | final  │
│    "message": "正在分析 Swagger 文件...",                                   │
│    "status": "running",       // running | success | error | warning        │
│    "progress": 15,            // 0-100 进度百分比 (可选)                     │
│    "extra": {...}             // 额外信息 (可选)                             │
│  }                                                                          │
│                                                                             │
│  【前端展示特性】                                                            │
│  ─────────────────────────────────────────────────────────────────────────  │
│  • 日志面板自动滚动到最新                                                   │
│  • 不同级别用不同颜色/缩进                                                  │
│  • 实时更新，无需刷新页面                                                   │
│  • 阶段完成时显示耗时统计                                                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.4 各阶段日志内容

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          各阶段日志内容                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【Phase 1: 规划】                                                          │
│  • 读取输入文件 (Swagger/业务规则/配置/数据)                                 │
│  • 调用 CLI 开始分析                                                        │
│  • 发现的 API 端点数量                                                      │
│  • 生成的测试用例数量                                                       │
│  • 保存用例文档                                                             │
│                                                                             │
│  【Phase 2: 生成】                                                          │
│  • 调用 CLI 生成代码                                                        │
│  • 每个生成的测试文件名和用例数                                             │
│  • 生成的配置文件 (conftest.py)                                             │
│                                                                             │
│  【Phase 3: 执行】                                                          │
│  • 开始执行，总用例数                                                       │
│  • 每个用例的执行状态 (PASS/FAIL)                                           │
│  • 触发自愈时的详细信息                                                     │
│    - 错误类型                                                               │
│    - 自愈尝试次数                                                           │
│    - 修复结果                                                               │
│  • 用例执行耗时                                                             │
│                                                                             │
│  【Phase 4: 交付】                                                          │
│  • 生成的报告文件                                                           │
│  • Bug 报告统计                                                             │
│  • 最终通过率                                                               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 九、部署架构（MVP阶段）

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        MVP 部署架构 (单机版)                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│                              ┌─────────────────┐                            │
│                              │    开发者电脑    │                            │
│                              └────────┬────────┘                            │
│                                       │                                      │
│   ┌───────────────────────────────────┼───────────────────────────────────┐ │
│   │                                   │                                   │ │
│   │   ┌───────────────────────────────▼───────────────────────────────┐  │ │
│   │   │                      Python Driver                             │  │ │
│   │   │                                                                │  │ │
│   │   │   启动方式:                                                    │  │ │
│   │   │   $ python main.py --swagger api.json --requirements rules.md │  │ │
│   │   │                                                                │  │ │
│   │   │   或 Web模式:                                                  │  │ │
│   │   │   $ python app.py  # 启动Flask服务                            │  │ │
│   │   │   访问 http://localhost:5000                                  │  │ │
│   │   │                                                                │  │ │
│   │   └───────────────────────────────┬───────────────────────────────┘  │ │
│   │                                   │                                   │ │
│   │                        subprocess │                                   │ │
│   │                                   ▼                                   │ │
│   │   ┌───────────────────────────────────────────────────────────────┐  │ │
│   │   │                    Claude Code CLI                             │  │ │
│   │   │                                                                │  │ │
│   │   │   前置条件:                                                    │  │ │
│   │   │   • 已安装 Claude Code CLI                                    │  │ │
│   │   │   • 已登录 Anthropic 账号                                     │  │ │
│   │   │   • 网络可访问 Anthropic API                                  │  │ │
│   │   │                                                                │  │ │
│   │   └───────────────────────────────────────────────────────────────┘  │ │
│   │                                                                       │ │
│   │   依赖:                                                               │ │
│   │   • Python 3.10+                                                     │ │
│   │   • Node.js (Claude Code CLI)                                        │ │
│   │   • pytest, pyyaml, rich                                             │ │
│   │                                                                       │ │
│   └───────────────────────────────────────────────────────────────────────┘ │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 十、项目目录结构

```
smart-dev-mantis/                      # 项目根目录 (v1.7 更名)
├── docs/                              # 文档目录
│   ├── 项目立项书.md
│   └── 技术选型与整体流程.md
│
├── src/                               # 主代码目录
│   ├── core/                          # 核心业务逻辑
│   │   ├── __init__.py
│   │   ├── workflow_engine.py         # 工作流引擎 (核心编排器)
│   │   ├── cli_adapter.py             # CLI适配器 + CLISession
│   │   ├── prompt_builder.py          # Prompt构建器
│   │   ├── pytest_runner.py           # Pytest执行器
│   │   ├── result_judge.py            # 结果仲裁器
│   │   ├── input_parser.py            # 输入解析器
│   │   ├── data_loader.py             # 测试数据加载器
│   │   ├── prd_parser.py              # PRD文档解析器
│   │   ├── dependency_analyzer.py     # 静态依赖分析器
│   │   ├── dependency_explorer.py     # 动态依赖探测器 (v1.7 新增)
│   │   ├── testcase_parser.py         # 测试用例解析器 (v1.7 新增)
│   │   ├── skeleton_writer.py         # 骨架文件生成器 (v1.7 新增)
│   │   ├── report_generator.py        # 业务报告生成器 (v1.7 新增)
│   │   └── load_test_runner.py        # 压力测试运行器
│   │
│   ├── models/                        # 数据模型
│   │   ├── __init__.py
│   │   ├── context.py                 # TaskContext, TestMode, WorkflowConfig
│   │   ├── result.py                  # CLIResult, ErrorInfo, TestCaseResult
│   │   ├── report.py                  # FinalReport, BugReport, TestCaseDoc
│   │   ├── dependency.py              # DependencyLink, ResourceInfo (v1.7 新增)
│   │   └── load_test.py               # LoadTestConfig, LoadTestResult
│   │
│   ├── templates/                     # Prompt模板 (7个)
│   │   ├── plan_prompt.txt            # Phase 1: 接口测试规划
│   │   ├── business_plan_prompt.txt   # Phase 1: 业务测试规划
│   │   ├── generate_prompt.txt        # Phase 2: 代码生成
│   │   ├── heal_syntax_prompt.txt     # Phase 3: 语法自愈
│   │   ├── heal_logic_prompt.txt      # Phase 3: 逻辑自愈
│   │   ├── finalize_prompt.txt        # Phase 4: 交付整理
│   │   └── load_test_prompt.txt       # 压测脚本生成
│   │
│   ├── web/                           # Web 界面
│   │   ├── app.py                     # Flask + SocketIO 应用
│   │   └── templates/                 # HTML 模板
│   │       └── index.html
│   │
│   ├── utils/                         # 工具类 (预留)
│   └── main.py                        # CLI入口
│
├── output/                            # 输出目录 (每次执行创建新目录)
│   └── YYYY-MM-DD_HHMMSS/             # 时间戳目录
│       ├── testcases.md               # 测试用例文档
│       ├── dependency_analysis.json   # 静态依赖分析结果 (v1.7 新增)
│       ├── explored_data.json         # 动态探测数据 (v1.7 新增)
│       ├── analysis_result.json       # 业务分析结果 (v1.7 新增)
│       ├── test_data_*.csv            # 生成的测试数据 (v1.7 新增)
│       ├── tests/                     # 测试脚本
│       │   ├── conftest.py            # Pytest配置 + Fixtures
│       │   ├── pytest.ini             # Pytest运行配置
│       │   ├── requirements.txt       # 测试依赖
│       │   └── test_*.py              # 测试文件 (含 # TestCase: TC-XXX 标记)
│       ├── reports/                   # 执行报告
│       │   ├── report.html            # Pytest HTML报告
│       │   ├── results.xml            # JUnit XML
│       │   └── business_report.html   # 业务级报告 (v1.7 新增)
│       └── bug_report.json            # Bug清单
│
├── run_web.py                         # Web服务入口
├── requirements.txt
└── README.md
```

---

## 十一、Web 模块架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Web 模块架构                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【技术栈】Flask + Flask-SocketIO                                            │
│                                                                             │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                        src/web/app.py                                  │  │
│  │                                                                        │  │
│  │  Flask REST API                     WebSocket 命名空间                  │  │
│  │  ───────────────────                ──────────────────                 │  │
│  │  POST /api/run                      /ws                                │  │
│  │  GET  /api/status/<id>                emit('log')     # 实时日志       │  │
│  │  GET  /api/download/<id>/<type>       emit('state')   # 状态变更       │  │
│  │  POST /api/cancel/<id>                emit('todos')   # Todo进度       │  │
│  │  GET  /api/tasks                      emit('result')  # 最终结果       │  │
│  │                                       emit('error')   # 错误信息       │  │
│  │  【压测接口】                                                           │  │
│  │  POST /api/load-test                                                   │  │
│  │  GET  /api/load-test/<id>/status                                       │  │
│  │  POST /api/load-test/<id>/stop                                         │  │
│  │  GET  /api/load-test/<id>/report                                       │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【TaskManager 类】                                                          │
│  ─────────────────────────────────────────────────────────────────────────  │
│  职责: 管理单个测试任务的生命周期                                            │
│                                                                             │
│  class TaskManager:                                                         │
│      task_id: str                   # 任务唯一ID (UUID)                     │
│      status: str                    # pending|running|completed|cancelled   │
│      report: Optional[FinalReport]  # 最终报告对象                          │
│      error: Optional[str]           # 错误信息                              │
│      output_dir: Optional[str]      # 输出目录路径                          │
│                                                                             │
│      emit_log(level, phase, msg)    # 发送日志事件到前端                    │
│      emit_state(state, msg)         # 发送状态变更通知                      │
│      emit_todos(todos)              # 发送Todo进度更新                      │
│      emit_result(report)            # 发送最终执行结果                      │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【后台任务执行流程】                                                        │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│   浏览器                      Flask                     WorkflowEngine      │
│      │                          │                            │             │
│      │─ POST /api/run ─────────>│                            │             │
│      │                          │─ 创建 TaskManager ────────>│             │
│      │                          │─ 启动后台线程 ────────────>│             │
│      │<─── task_id ────────────│                            │             │
│      │                          │                            │             │
│      │ WebSocket connect ──────>│                            │             │
│      │                          │                            │             │
│      │                          │<── emit('log') ───────────│             │
│      │<─── log事件 ────────────│                            │             │
│      │                          │<── emit('todos') ─────────│             │
│      │<─── todos事件 ──────────│                            │             │
│      │                          │<── emit('state') ─────────│             │
│      │<─── state事件 ──────────│                            │             │
│      │                          │                            │             │
│      │                          │<── emit('result') ────────│             │
│      │<─── result事件 ─────────│                            │             │
│      │                          │                            │             │
│                                                                             │
│  【执行步骤详解】                                                            │
│  1. 创建带时间戳的输出目录 (output/YYYY-MM-DD_HHMMSS/)                       │
│  2. 解析输入参数 → TaskContext                                               │
│  3. 配置 WorkflowConfig (包含回调函数)                                       │
│  4. 在后台线程启动 WorkflowEngine.run()                                     │
│  5. 实时推送日志/进度/状态到 WebSocket                                       │
│  6. 处理完成/取消/异常情况                                                   │
│  7. 保存最终报告到文件系统                                                   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  【回调机制】                                                                │
│  ─────────────────────────────────────────────────────────────────────────  │
│                                                                             │
│  WorkflowConfig 中的回调函数:                                                │
│  ┌──────────────────────┬───────────────────────────────────────────────┐  │
│  │ on_log               │ 日志输出时触发 → emit('log')                   │  │
│  │ on_phase_change      │ 阶段切换时触发 → emit('state')                 │  │
│  │ on_todo_update       │ Todo更新时触发 → emit('todos')                 │  │
│  │ on_test_complete     │ 单个测试完成时触发                             │  │
│  └──────────────────────┴───────────────────────────────────────────────┘  │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 十二、实施路线图

| 阶段 | 目标 | 交付物 |
|------|------|--------|
| **Phase 1: MVP** | 跑通单接口完整流程 | CLI工具 + 基础报告 |
| **Phase 2: Pilot** | 支持Swagger批量导入 | Web UI + 完整报告 |
| **Phase 3: Integration** | 接入CI/CD流水线 | Jenkins/GitLab插件 |

---

## 附录：已验证的技术点

| 技术点 | 状态 | 验证结果 |
|--------|------|----------|
| Claude Code CLI 非交互模式 | ✅ | `-p` 参数可用 |
| JSON 输出格式 | ✅ | 结构化输出，易解析 |
| Session ID 获取 | ✅ | 可从响应中提取 |
| subprocess 调用 | ✅ | 通信正常 |
| 会话恢复 (`--resume`) | 📋 | CLI支持，待集成测试 |
