这是一份经过深度展开、结构严谨的**技术立项方案书**。

你可以直接将其复制到 Word、Confluence 或飞书文档中。这份文档不仅融合了我们讨论的所有技术细节（CLI 封装、骨架与灵魂策略、双重自愈），还使用了专业的工程化术语，非常适合向上汇报或跨部门评审。

------



# 项目立项书：基于 LLM Agent 编排的下一代接口自动化测试平台



文档状态： 草稿/评审中

拟稿日期： 2025-11-28

相关人员： [你的团队/姓名]

------



## 1. 背景与痛点 (Background & Pain Points)



在当前的研发流程中，接口自动化测试虽然已推行，但在落地过程中面临两大核心瓶颈，严重制约了研发效能与交付质量：

1. **脚本维护成本高（ROI 低）：**
   - 随着业务快速迭代，接口定义（Schema）变动频繁。
   - 传统自动化脚本高度依赖硬编码（Hard-coding），一旦接口变更，需要人工逐行修复，维护工作量巨大，导致自动化测试常年处于“年久失修”的状态。
2. **测试覆盖率不足（漏测风险）：**
   - 人工编写脚本往往由于时间紧迫，仅覆盖“Happy Path（主流程）”。
   - 对于**边界条件**（如超长字符、负数金额）、**异常流程**（如库存不足、并发扣款）以及**业务规则组合**，覆盖率极低，导致大量逻辑 Bug 逃逸至生产环境。

项目目标：

利用最新的 LLM（大语言模型）与 CLI 工程化能力，构建一个具备自主编程、自主执行、自主修复能力的测试 Agent，实现从“人写代码”向“人审代码”的模式转型。

------



## 2. 总体架构设计 (Technical Architecture)



为了降低开发成本并利用业界最先进的模型能力，本项目不采用传统的“对接 LLM API 从零开发”模式，而是采用 **Agent Orchestration（智能体编排）** 架构。



### 2.1 核心组件



我们采用 **“指挥官 (Driver) + 执行引擎 (Engine)”** 的双层架构：

1. **控制中枢 (Python Driver) —— 指挥官**
   - **职责：** 负责任务拆解、上下文管理、策略决策、流程控制。
   - **实现：** 基于 Python 开发，利用 `pexpect` 或 `subprocess` 库实现对下层工具的封装与交互。
2. **执行引擎 (Claude Code / Codex CLI) —— 特种兵**
   - **职责：** 负责具体的代码编写、文件系统操作（读写/Diff）、终端命令执行。
   - **优势：** 复用 CLI 工具原生具备的“读取项目全貌”、“应用代码补丁”和“错误日志分析”能力，避免重复造轮子。



### 2.2 交互流程图



Plaintext

```
[ 输入: Swagger + 需求 ]
       |
       v
[ Python Driver (Manager) ]  <-- (双重自愈循环) -->  [ Claude Code CLI (Worker) ]
       |                                                    |
   解析策略与提示词                                     1. 生成 Pytest 脚本
       |                                             2. 执行 Pytest
       v                                             3. 分析报错日志并修复
[ 测试报告 & Bug 清单 ]  <--------------------------  4. 提交测试结果
```

------



## 3. 系统输入与输出定义 (Inputs & Outputs)



明确的 I/O 定义是工程落地的基石，确保 Agent 在受控范围内运行。



### 3.1 输入清单 (Inputs)



输入采用**"软硬结合"**策略：

1. **骨架层 (The Skeleton) —— 刚性约束**
   - **内容：** `swagger.json` / OpenAPI 定义 / Protobuf 文件。
   - **作用：** **Grounding（基准）**。强制 Agent 严格遵循 URL、Method、参数名和数据类型，确保生成的脚本 100% 可运行（无语法/调用错误）。
2. **灵魂层 (The Soul) —— 柔性逻辑**
   - **内容：** `requirements.txt` (业务规则描述) / User Story。
   - **作用：** **Oracle（裁判）**。用于指导生成断言（Assertions）。例如："库存不足时必须返回错误码 1002，而非 200"。
3. **环境层 (Config) —— 运行依赖**
   - **内容：** `config.yaml`（Base URL, Auth Token, DB 连接串）及现有的工具类库路径（Utils）。



### 3.2 输出清单 (Outputs)



1. **测试资产 (Test Assets):**
   - 可直接运行、可提交 Git 的 `test_xxx.py` 脚本（含 Setup/Teardown）。
2. **执行结果 (Execution Results):**
   - 标准测试报告 (`report.html`, `results.xml`)。
   - 包含 Request/Response 的完整运行日志。
3. **智能洞察 (Insights):**
   - **Bug 分析报告：** 当测试失败时，Agent 输出的 JSON 摘要，区分"脚本错误"还是"业务 Bug"，并给出根因分析。

------



## 4. 核心方法论：骨架与灵魂融合策略 (Skeleton & Soul Strategy)



为了解决“AI 胡乱生成接口参数（幻觉）”与“AI 无法理解复杂业务逻辑”的矛盾，我们提出**双通道输入策略**：



### 4.1 骨架 (Skeleton) —— 解决"跑得通"



- **来源：** **Swagger / OpenAPI / 源码定义**。
- **作用：** 作为 **Grounding（基准）**。
- **机制：** 强制 Agent 严格遵循文档中的 URL、Method、参数名、数据类型。
- **价值：** 确保生成的脚本在**语法和协议层面**是 100% 正确的，杜绝 404 Not Found 或 400 Bad Request 错误。



### 4.2 灵魂 (Soul) —— 解决"测得准"



- **来源：** **需求文档 / User Story / 自然语言规则**。
- **作用：** 作为 **Oracle（真理裁判）**。
- **机制：** 仅仅用来生成 **Assertions（断言）**。
- **价值：** Agent 不再只校验 `code == 200`，而是校验业务逻辑。例如：“根据需求，库存不足时必须返回错误码 1001，如果接口返回了 200，则判定为 Bug”。

------



## 5. 落地实施：双重自愈工作流 (Double-Loop Workflow)



这是本 Agent 区别于普通脚本生成器的核心能力。



### 阶段一：生成与执行 (Generation)



Driver 将 Swagger（骨架）与需求（灵魂）组装成 Master Prompt，指挥 CLI 生成 Pytest 测试用例。



### 阶段二：第一层自愈 —— 语法修复 (Syntax Healing)



- **场景：** 测试脚本执行报错（Python 语法错误、依赖缺失、接口调用 400/500）。
- **动作：**
  1. CLI 自动捕获终端的 Traceback 报错日志。
  2. CLI 读取报错文件，分析原因。
  3. **自动修改代码**并重新运行。
- **目标：** 确保脚本能够成功运行结束。



### 阶段三：第二层自愈 —— 逻辑裁判 (Logic Validation)



- **场景：** 测试脚本执行成功（HTTP 200），但我们需要确认是否“假成功”。
- **动作：**
  1. Driver 获取执行结果（Response Body）。
  2. Driver 将“需求文档”与“实际结果”再次喂给 LLM，提问：*“根据需求，这个场景应该是失败的，但实际返回了成功，这是代码 Bug 还是测试脚本写错了？”*
  3. **判定：** 如果是 Bug，输出告警；如果是脚本断言写错了，指示 Agent 修正断言。



### 阶段四：交付与清理 (Finalization)



- 生成最终 HTML 报告。
- 触发 Teardown 清理测试产生的脏数据。

------



## 6. 质量保障机制 (Quality Assurance)



为了确保 Agent 产出的测试是安全且有效的，必须遵循以下工程化原则：



### 6.1 数据生命周期管理 (Data Lifecycle)



- **痛点：** 硬编码 ID 导致数据冲突；脏数据污染环境。
- **策略：** 强制 Agent 遵循 `Setup -> Test -> Teardown` 模式。
  - **动态构造：** 测试“详情”接口前，必须先调用“创建”接口获取动态 ID。
  - **环境复原：** 测试结束后，自动调用“删除”接口或数据库清理指令。



### 6.2 副作用验证 (Side-Effect Verification)



- **痛点：** 只验证接口返回“成功”，未验证数据是否真实改变。
- **策略：** 引入**“读写闭环”**校验。
  - 对于所有写操作（POST/PUT），必须紧跟一个读操作（GET/DB Query）。
  - *示例：转账接口返回 200 后，立即查询余额，断言 `余额 == 原余额 - 转账金额`。*



### 6.3 智能边界测试矩阵 (Mutation Matrix)



Agent 必须内置一套“坏数据”模版，针对每个参数自动生成攻击性测试：

- **类型边界：** `null`, `None`, `""`, 超长字符串, 特殊字符 (Emoji/SQL关键字)。
- **数值边界：** `-1`, `0`, 最大整数, 浮点数。
- **业务边界：** 基于常识推断（如：结束时间 < 开始时间，年龄 > 200）。

------



## 7. 预期收益与里程碑 (ROI & Roadmap)





### 预期收益



1. **效能提升：** 单个接口的测试脚本编写 + 调试时间缩短 **80%** 以上。
2. **质量防线：** 对边界条件和异常流程的覆盖率提升至 **90%**，大幅减少低级 Bug 上线。
3. **资产沉淀：** 自动生成的测试脚本可持久化保存，成为回归测试资产。



### 实施路线图



- **Phase 1 (MVP - 2周)：**
  - 完成 Python Driver + Claude Code CLI 的环境搭建与打通。
  - 选取 1-2 个非核心接口（如登录、用户查询）进行“骨架+灵魂”策略验证。
- **Phase 2 (Pilot - 1个月)：**
  - 完善数据清理与沙箱机制。
  - 在部门内部试运行，支持上传 Swagger 自动吐出测试报告。
- **Phase 3 (Integration - Q4)：**
  - 接入 CI/CD 流水线。
  - 探索基于流量录制（Traffic Replay）的场景化测试生成。

------

结论：

本项目不仅是一个测试工具的升级，更是对测试开发模式的一次革新。通过引入 Agent 编排技术，我们将实现测试工作的**“去人工化”（针对重复劳动）与“智能化”**（针对逻辑验证），具有极高的技术价值与落地可行性。