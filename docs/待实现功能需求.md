# Smart Dev Mantis - 待实现功能需求文档

> 文档版本: v1.1
> 创建日期: 2025-12-13
> 最后更新: 2025-12-13
> 文档状态: 需求收集
> 当前项目完成度: 90%

---

## 一、文档目的

本文档梳理 Smart Dev Mantis 项目当前已实现功能与待实现功能的差距，为后续迭代提供需求参考。

---

## 二、当前完成状态

### 2.1 已完整实现的核心功能

| 模块 | 完成度 | 说明 |
|------|--------|------|
| 四阶段工作流 | 100% | 规划 → 生成 → 执行+自愈 → 交付 |
| CLI 适配器 | 100% | Claude Code CLI 非交互调用 |
| 依赖分析 | 100% | 静态分析 + 动态探测 |
| 三种测试模式 | 100% | INTERFACE / BUSINESS / COMPLETE |
| 自愈机制 | 100% | 语法自愈 + 逻辑自愈 (最多3次) |
| 报告生成 | 100% | HTML + JSON + JUnit XML |
| Web UI | 100% | 实时日志、进度推送、取消支持 |
| PRD 解析 | 100% | 支持 .md / .docx / .txt |
| 测试数据加载 | 100% | 支持 .xlsx / .csv |
| Prompt 模板 | 100% | 7个模板文件，共1555行 |

### 2.2 核心模块清单

```
src/
├── core/                        # 核心模块 (14个)
│   ├── workflow_engine.py       # 工作流引擎 ✅
│   ├── cli_adapter.py           # CLI 适配器 ✅
│   ├── prompt_builder.py        # Prompt 构建器 ✅
│   ├── input_parser.py          # 输入解析器 ✅
│   ├── pytest_runner.py         # Pytest 执行器 ✅
│   ├── result_judge.py          # 结果仲裁器 ✅
│   ├── dependency_analyzer.py   # 静态依赖分析 ✅
│   ├── dependency_explorer.py   # 依赖探测器 ✅
│   ├── skeleton_writer.py       # 测试骨架生成 ✅
│   ├── testcase_parser.py       # 用例文档解析 ✅
│   ├── report_generator.py      # 报告生成器 ✅
│   ├── prd_parser.py            # PRD 解析器 ✅
│   ├── data_loader.py           # 数据加载器 ✅
│   └── load_test_runner.py      # 压测执行器 ✅ (含智能筛选)
├── models/                      # 数据模型 (5个) ✅
├── web/                         # Web 层 ✅
└── templates/                   # Prompt 模板 (7个) ✅
```

### 2.3 最近修复的问题 (2025-12-13)

#### 2.3.1 PRD/测试数据断链修复

**问题描述**: Phase 1 规划阶段正确解析了 PRD 文档并提取了 `scenarios`、`business_rules`、`data_mapping`，但 Phase 2 代码生成阶段没有将这些数据注入到 Prompt 中，导致生成的测试代码缺少业务规则验证。

**修复内容**:
- `src/core/prompt_builder.py`: 在 `build_generate_prompt()` 中注入 scenarios_block、rules_block、data_mapping_block
- `src/templates/generate_prompt.txt`: 添加业务场景测试、规则测试、数据驱动测试的生成模板

**修复后数据流**:
```
Phase 1 (规划)              Phase 2 (生成)
─────────────────          ─────────────────
PRD → scenarios      ──→   ✅ 注入 Prompt → 场景测试
    → business_rules ──→   ✅ 注入 Prompt → 规则测试
测试数据 → data_mapping ──→ ✅ 注入 Prompt → 参数化测试
```

#### 2.3.2 逻辑自愈增强

**问题描述**: 逻辑自愈阶段仅使用 `context.requirements`，未使用 Phase 1 提取的结构化规则。

**修复内容**:
- `src/core/workflow_engine.py`: 优先使用 `business_rules`，其次 `prd_document`，最后兼容旧版 `requirements`

#### 2.3.3 压力测试智能筛选

**问题描述**: `_parse_test_results()` 返回空字典，无法根据功能测试结果筛选压测接口。

**修复内容**:
- `src/core/load_test_runner.py`: 实现 JUnit XML 解析，支持 `only_passed` 配置仅压测通过的接口

---

## 三、待实现功能需求

### 3.1 P0 优先级 - 必须实现

#### 3.1.1 单元测试与集成测试

**需求背景**: 当前项目基本无测试覆盖，代码质量无法保障

**需求描述**:
```
tests/
├── unit/                        # 单元测试
│   ├── test_input_parser.py     # 输入解析测试
│   ├── test_prompt_builder.py   # Prompt 构建测试
│   ├── test_result_judge.py     # 结果仲裁测试
│   ├── test_dependency_analyzer.py
│   ├── test_data_loader.py
│   └── test_prd_parser.py
├── integration/                 # 集成测试
│   ├── test_workflow_engine.py  # 工作流端到端
│   └── test_web_api.py          # Web API 测试
└── fixtures/                    # 测试数据
    ├── sample_swagger.json
    ├── sample_prd.md
    └── sample_data.xlsx
```

**验收标准**:
- [ ] 核心模块测试覆盖率 > 80%
- [ ] CI 流水线自动运行测试
- [ ] 测试报告生成

**预估工作量**: 3-5 天

---

#### 3.1.2 持久化存储

**需求背景**: 当前任务数据仅存内存，服务重启后丢失

**需求描述**:

1. **数据库选型**: SQLite (轻量) 或 PostgreSQL (生产)

2. **数据模型设计**:
```sql
-- 任务表
CREATE TABLE tasks (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(255),
    status VARCHAR(20),          -- PENDING/RUNNING/COMPLETED/FAILED/CANCELLED
    test_mode VARCHAR(20),       -- INTERFACE/BUSINESS/COMPLETE
    config JSON,                 -- 环境配置
    created_at TIMESTAMP,
    updated_at TIMESTAMP,
    completed_at TIMESTAMP
);

-- 执行结果表
CREATE TABLE task_results (
    id INTEGER PRIMARY KEY,
    task_id VARCHAR(36) REFERENCES tasks(id),
    total_cases INTEGER,
    passed INTEGER,
    failed INTEGER,
    pass_rate DECIMAL(5,2),
    duration DECIMAL(10,2),
    report_path VARCHAR(500),
    created_at TIMESTAMP
);

-- 任务日志表
CREATE TABLE task_logs (
    id INTEGER PRIMARY KEY,
    task_id VARCHAR(36) REFERENCES tasks(id),
    level VARCHAR(10),           -- INFO/WARNING/ERROR
    message TEXT,
    created_at TIMESTAMP
);
```

3. **功能要求**:
   - 任务历史查询
   - 结果持久化
   - 日志存储与检索
   - 支持分页与筛选

**验收标准**:
- [ ] 服务重启后任务历史可查询
- [ ] 支持按时间/状态/模式筛选任务
- [ ] 日志可追溯

**预估工作量**: 3-4 天

---

### 3.2 P1 优先级 - 重要功能

#### 3.2.1 CI/CD 集成

**需求背景**: 需要与现有 DevOps 流水线集成

**需求描述**:

1. **命令行退出码**:
```bash
# 成功返回 0，失败返回非 0
python -m src.main --swagger api.json --base-url http://api.example.com
echo $?  # 0=全部通过, 1=有失败, 2=执行错误
```

2. **Jenkins 集成**:
```groovy
// Jenkinsfile 示例
pipeline {
    stages {
        stage('API Test') {
            steps {
                sh 'python -m src.main --swagger api.json --base-url $API_URL --output ./results'
            }
            post {
                always {
                    junit 'results/results.xml'
                    publishHTML([reportDir: 'results', reportFiles: 'business_report.html'])
                }
            }
        }
    }
}
```

3. **GitHub Actions 模板**:
```yaml
# .github/workflows/api-test.yml
name: API Test
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run API Tests
        run: python -m src.main --swagger api.json --base-url ${{ secrets.API_URL }}
      - name: Upload Results
        uses: actions/upload-artifact@v3
        with:
          name: test-results
          path: output/
```

4. **GitLab CI 模板**:
```yaml
# .gitlab-ci.yml
api-test:
  stage: test
  script:
    - python -m src.main --swagger api.json --base-url $API_URL
  artifacts:
    reports:
      junit: output/results.xml
    paths:
      - output/
```

**验收标准**:
- [ ] CLI 支持退出码
- [ ] 提供 Jenkins/GitHub/GitLab 模板
- [ ] 文档说明集成方式

**预估工作量**: 2-3 天

---

#### 3.2.2 通知系统

**需求背景**: 测试完成后需要及时通知相关人员

**需求描述**:

1. **邮件通知**:
```python
# 配置示例
notification:
  email:
    enabled: true
    smtp_host: smtp.example.com
    smtp_port: 587
    sender: test@example.com
    recipients:
      - dev@example.com
      - qa@example.com
    on_success: false    # 成功时不发送
    on_failure: true     # 失败时发送
```

2. **Webhook 回调**:
```python
# 配置示例
notification:
  webhook:
    enabled: true
    url: https://your-server.com/api/callback
    method: POST
    headers:
      Authorization: Bearer xxx
    # 回调数据格式
    payload:
      task_id: "xxx"
      status: "COMPLETED"
      pass_rate: 95.5
      report_url: "https://..."
```

3. **企业微信/钉钉**:
```python
notification:
  wechat_work:
    enabled: true
    webhook_url: https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx

  dingtalk:
    enabled: true
    webhook_url: https://oapi.dingtalk.com/robot/send?access_token=xxx
```

**验收标准**:
- [ ] 支持邮件通知 (SMTP)
- [ ] 支持 Webhook 回调
- [ ] 支持至少一种 IM 通知
- [ ] 可配置触发条件

**预估工作量**: 2-3 天

---

### 3.3 P2 优先级 - 增强功能

#### 3.3.1 多项目管理

**需求背景**: 支持多个项目的测试管理

**需求描述**:

1. **项目空间**:
```
项目 A (电商平台)
├── 配置: base_url, auth_token
├── Swagger 文件
├── PRD 文档
├── 测试数据
└── 历史任务

项目 B (支付系统)
├── 配置: ...
└── ...
```

2. **功能要求**:
   - 项目 CRUD
   - 项目级配置模板
   - 项目成员管理 (可选)
   - 项目切换

3. **数据模型**:
```sql
CREATE TABLE projects (
    id VARCHAR(36) PRIMARY KEY,
    name VARCHAR(255),
    description TEXT,
    default_config JSON,
    created_at TIMESTAMP
);

ALTER TABLE tasks ADD COLUMN project_id VARCHAR(36) REFERENCES projects(id);
```

**验收标准**:
- [ ] 支持创建/编辑/删除项目
- [ ] 任务关联到项目
- [ ] 按项目筛选任务历史

**预估工作量**: 3-4 天

---

#### 3.3.2 压力测试完善

**需求背景**: 当前 LoadTestRunner 仅有骨架，功能不完整

> **2025-12-13 更新**: 已实现智能筛选功能
> - ✅ `_parse_test_results()` 解析 JUnit XML 测试结果
> - ✅ `only_passed` 配置：仅压测功能测试通过的接口
> - ✅ `target_endpoints` 配置：指定压测接口列表

**需求描述**:

1. **Locust 脚本自动生成**: ✅ 已实现
   - 从 Swagger 生成压测脚本
   - 支持自定义并发数、持续时间
   - 支持 ramp-up 配置

2. **压测执行**: ✅ 已实现
   - 启动 Locust master/worker
   - 实时监控 RPS、响应时间、错误率
   - 支持手动停止

3. **智能筛选**: ✅ **新增**
   - 解析功能测试 JUnit XML 结果
   - 仅压测通过的接口 (only_passed 模式)
   - 支持指定接口列表

4. **结果分析**: ⚠️ 待完善
   - 生成压测报告
   - 响应时间分布图
   - 错误类型统计
   - 性能瓶颈识别

5. **Web UI 集成**: ⚠️ 待完善
   - 压测配置面板
   - 实时图表展示
   - 历史对比

**验收标准**:
- [x] 自动生成 Locust 脚本
- [x] 支持配置并发参数
- [x] 智能筛选（仅压测通过接口）
- [ ] 增强压测报告
- [ ] Web UI 可视化

**预估工作量**: 3-4 天 (剩余部分)

---

#### 3.3.3 环境管理

**需求背景**: 支持多环境配置 (开发/测试/生产)

**需求描述**:

1. **环境配置**:
```yaml
environments:
  dev:
    base_url: http://dev-api.example.com
    auth_token: dev-token
    timeout: 30

  test:
    base_url: http://test-api.example.com
    auth_token: test-token
    timeout: 60

  prod:
    base_url: https://api.example.com
    auth_token: prod-token
    timeout: 120
```

2. **功能要求**:
   - 环境 CRUD
   - 环境切换
   - 敏感信息加密存储
   - 环境变量支持

**验收标准**:
- [ ] 支持多环境配置
- [ ] 执行时可选择环境
- [ ] 敏感信息安全存储

**预估工作量**: 2-3 天

---

### 3.4 P3 优先级 - 可选功能

#### 3.4.1 用户认证与权限

**需求背景**: 多人使用场景下需要身份认证

**需求描述**:

1. **用户管理**:
   - 注册/登录/登出
   - 密码重置
   - 用户信息管理

2. **权限控制**:
   - 角色: 管理员 / 普通用户 / 只读用户
   - 项目级权限
   - API 访问控制

3. **API Key**:
   - 生成 API Key
   - Key 权限配置
   - Key 有效期管理

**验收标准**:
- [ ] 支持用户登录
- [ ] 支持角色权限
- [ ] 支持 API Key 认证

**预估工作量**: 4-5 天

---

#### 3.4.2 高级报告功能

**需求背景**: 提供更丰富的报告分析能力

**需求描述**:

1. **报告对比**:
   - 本次 vs 上次执行对比
   - 新增失败 / 修复成功标记
   - 趋势变化分析

2. **趋势图表**:
   - 通过率趋势
   - 执行时间趋势
   - Bug 数量趋势

3. **导出功能**:
   - 导出 PDF 报告
   - 导出 Excel 明细
   - 自定义报告模板

**验收标准**:
- [ ] 支持历史报告对比
- [ ] 展示趋势图表
- [ ] 支持 PDF/Excel 导出

**预估工作量**: 4-5 天

---

#### 3.4.3 测试数据管理

**需求背景**: 统一管理测试数据，支持数据复用

**需求描述**:

1. **数据池**:
   - 上传/管理测试数据文件
   - 数据分类 (用户数据/订单数据/...)
   - 数据版本控制

2. **数据生成**:
   - 基于规则自动生成测试数据
   - 支持 Faker 库
   - 自定义数据模板

3. **数据关联**:
   - 数据与接口自动匹配
   - 数据集复用

**验收标准**:
- [ ] 支持数据文件管理
- [ ] 支持自动生成数据
- [ ] 支持数据与接口关联

**预估工作量**: 4-5 天

---

## 四、技术选型建议

| 功能 | 推荐技术 | 备选 |
|------|----------|------|
| 数据库 | SQLite (轻量) | PostgreSQL (生产) |
| ORM | SQLAlchemy | Peewee |
| 邮件发送 | smtplib | SendGrid API |
| 图表 | ECharts | Chart.js |
| PDF 导出 | WeasyPrint | ReportLab |
| 用户认证 | Flask-Login | JWT |
| 任务队列 | Celery (可选) | RQ |

---

## 五、依赖新增

```
# requirements.txt 新增

# P0: 测试
pytest>=7.0
pytest-cov>=4.0
pytest-mock>=3.0

# P0: 持久化
sqlalchemy>=2.0
alembic>=1.12          # 数据库迁移

# P1: 通知
# (使用标准库 smtplib, 无需额外依赖)

# P2: 压力测试
locust>=2.20

# P3: 报告导出
weasyprint>=60.0       # PDF 导出
xlsxwriter>=3.1        # Excel 导出

# P3: 用户认证
flask-login>=0.6
bcrypt>=4.0
```

---

## 六、实施路线图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            实施路线图                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  Phase 1: 基础建设 (1-2 周)                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • 单元测试框架搭建                                                  │   │
│  │  • 核心模块测试覆盖                                                  │   │
│  │  • 持久化存储实现 (SQLite)                                           │   │
│  │  • 任务历史查询 API                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    ↓                                        │
│  Phase 2: 自动化集成 (1 周)                                                  │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • CLI 退出码支持                                                    │   │
│  │  • CI/CD 模板 (Jenkins/GitHub/GitLab)                                │   │
│  │  • 通知系统 (邮件 + Webhook)                                         │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    ↓                                        │
│  Phase 3: 功能增强 (2 周)                                                    │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • 多项目管理                                                        │   │
│  │  • 环境配置管理                                                      │   │
│  │  • 压力测试完善                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    ↓                                        │
│  Phase 4: 高级功能 (2 周, 可选)                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │  • 用户认证与权限                                                    │   │
│  │  • 高级报告 (对比/趋势/导出)                                         │   │
│  │  • 测试数据管理                                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 七、工作量估算汇总

| 优先级 | 功能 | 预估工作量 |
|--------|------|------------|
| **P0** | 单元测试与集成测试 | 3-5 天 |
| **P0** | 持久化存储 | 3-4 天 |
| **P1** | CI/CD 集成 | 2-3 天 |
| **P1** | 通知系统 | 2-3 天 |
| **P2** | 多项目管理 | 3-4 天 |
| **P2** | 压力测试完善 | 5-7 天 |
| **P2** | 环境管理 | 2-3 天 |
| **P3** | 用户认证与权限 | 4-5 天 |
| **P3** | 高级报告功能 | 4-5 天 |
| **P3** | 测试数据管理 | 4-5 天 |
| | **合计** | **33-44 天** |

---

## 八、风险与注意事项

1. **数据迁移**: 实现持久化后需考虑现有任务数据迁移
2. **兼容性**: 新功能需保持 CLI 和 Web 两种模式兼容
3. **性能**: 持久化和通知不应影响主流程执行性能
4. **安全性**: 敏感配置 (token/密码) 需加密存储
5. **测试覆盖**: 新功能需同步编写测试用例

---

## 九、参考资料

- [项目技术架构文档](./技术选型与整体流程.md)
- [业务扩展设计](../.claude/plans/enchanted-tumbling-crown.md)

---

> 文档维护: 请在实现对应功能后更新本文档状态
